<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Just for fun &#8211; Morisunshine's Blog</title>
<meta name="description" content="Describe this nonsense.">


<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://morisunshine.com/images/header_bg.jpg">

<meta name="twitter:title" content="Just for fun">
<meta name="twitter:description" content="Describe this nonsense.">
<meta name="twitter:creator" content="@morisunshine">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Just for fun">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="http://morisunshine.com/page3/index.html">
<meta property="og:site_name" content="Morisunshine's Blog">





<link rel="canonical" href="http://morisunshine.com/page3/">
<link href="http://morisunshine.com/feed.xml" type="application/atom+xml" rel="alternate" title="Morisunshine's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://morisunshine.com/assets/css/main.min.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://morisunshine.com/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://morisunshine.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://morisunshine.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://morisunshine.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://morisunshine.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://morisunshine.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://morisunshine.com/images/apple-touch-icon-144x144-precomposed.png">



</head>

<link rel="stylesheet" href="/assets/css/solarized_dark.css">

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://morisunshine.com">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://morisunshine.com/images/avatar.png" alt="Sheldon photo" class="author-photo">
					<h4>Sheldon</h4>
					<p>1991-12-10</p>
				</li>
				<li><a href="http://morisunshine.com/about/">Know More</a></li>
				<li>
					<a href="mailto:sheldon.zen@gmail.com"><i class="icon-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/morisunshine"><i class="icon-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://weibo.com/u/1626743220"><i class="icon-weibo"></i> Weibo</a>
				</li>
				
				
				<li>
					<a href="http://linkedin.com/in/morisunshine"><i class="icon-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/morisunshine"><i class="icon-github"></i> GitHub</a>
				</li>
				<li>
					<a href="http://stackoverflow.com/users/2194236/morisunshine"><i class="icon-stackexchange"></i> Stackexchange</a>
				</li>
				<li>
					<a href="http://instagram.com/morisunshine"><i class="icon-instagram"></i> Instagram</a>
				</li>
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://morisunshine.com/posts/">All Posts</a></li>
				<li><a href="http://morisunshine.com/tags/">All Tags</a></li>
			</ul>
		</li>
		<li><a href="http://morisunshine.com/feed">Feed</a></li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://morisunshine.com/images/header_bg.jpg" alt="Just for fun">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Morisunshine's Blog</h1>
      <h2>Just for fun</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<style type="text/css">body {background-image:url(/images/witewall_3.png);}</style>

<div id="main" role="main">
  
<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-02-27T00:00:00+08:00"><a href="http://morisunshine.com/ios/UICollectionView_UIKit_Dynamics/">February 27, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/UICollectionView_UIKit_Dynamics/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/UICollectionView_UIKit_Dynamics/" rel="bookmark" title="UICollectionView+UIKit Dynamics" itemprop="url">UICollectionView+UIKit Dynamics</a></h1>
    
  </header>
  <div class="entry-description">UIKit Dynamics 是 iOS 7 中基于物理动画引擎的一个新功能--它被特别设计使其能很好地与 collection views 配合工作，而后者是在 iOS 6 中才被引入的新特性。接下来，我们要好好看看如何将这两个特性结合在一起。 这篇文章将讨论两个结合使用 UIkit Dynamics 和 collection view 的例子。第一个例子展示了如何去实现像 iOS 7 里信息 app 中的消息泡泡的弹簧动效，然后再进一步结合平铺机制来实现布局的可伸缩性。第二个例子展现了如何用 UIKit Dynamics 来模拟牛顿摆，这个例子中物体可以一个个地加入到 collection view 中，并和其他物体发生相互作用。</div>
  <div class="entry-content">
    <div class="full-text"><p><a href="http://www.objc.io/issue-5/collection-views-and-uidynamics.html">原文</a>作者<a href="https://twitter.com/ashfurrow">Ash Furrow</a>。转载请注明出处！</p>

<p>感谢<a href="http://blog.codingcoder.com/">破土</a>参与翻译。</p>

<p>UIKit Dynamics 是 iOS 7 中基于物理动画引擎的一个新功能--它被特别设计使其能很好地与 collection views 配合工作，而后者是在 iOS 6 中才被引入的新特性。接下来，我们要好好看看如何将这两个特性结合在一起。 </p>

<p>这篇文章将讨论两个结合使用 UIkit Dynamics 和 collection view 的例子。第一个例子展示了如何去实现像 iOS 7 里信息 app 中的消息泡泡的弹簧动效，然后再进一步结合平铺机制来实现布局的可伸缩性。第二个例子展现了如何用 UIKit Dynamics 来模拟<a href="http://zh.wikipedia.org/wiki/%E7%89%9B%E9%A1%BF%E6%91%86">牛顿摆</a>，这个例子中物体可以一个个地加入到 collection view 中，并和其他物体发生相互作用。</p>

<p>在我们开始之前，我假定你们对 <code>UICollectionView</code> 是如何工作是有基本的了解——查看<a href="http://www.objccn.io/issue-3-3/">这篇 objc.io 文章</a>会有你想要的所有细节。我也假定你已经理解了 <code>UIKit Dynamics</code> 的工作原理--阅读这篇<a href="http://www.teehanlax.com/blog/introduction-to-uikit-dynamics/">博客</a>，可以了解更多 UIKit Dynamics 的知识。</p>

<blockquote>
<p><span class="secondary radius label">编者注</span> 如果您阅读本篇文章感觉有点吃力的话，可以先来看看 <a href="http://im.onevcat.com">@onevcat</a> 的<a href="http://onevcat.com/2012/06/introducing-collection-views/">《UICollectionView 入门》</a> 和<a href="http://onevcat.com/2013/06/uikit-dynamics-started/">《UIKit Dynamics 入门》</a>这两篇入门文章，帮助您快速补充相关知识。</p>
</blockquote>

<p>文章中的两个例子项目都已经在 GitHub 中:</p>

<ul>
<li><a href="https://github.com/objcio/issue-5-springy-collection-view">ASHSpringyCollectionView</a>（基于 <a href="https://github.com/TeehanLax/UICollectionView-Spring-Demo">UICollectionView Spring Demo</a>）</li>
<li><a href="https://github.com/objcio/issue-5-newtonian-collection-view">Newtownian UICollectionView</a></li>
</ul>

<h2>关于 UIDynamicAnimator</h2>

<p>支持 <code>UICollectionView</code> 实现 UIKit Dynamics 的最关键部分就是 <code>UIDynamicAnimator</code>。要实现这样的 UIKit Dynamics 的效果，我们需要自己自定义一个继承于 <code>UICollectionViewFlowLayout</code> 的子类，并且在这个子类对象里面持有一个 UIDynamicAnimator 的对象。</p>

<p>当我们创建自定义的 dynamic animator 时，我们不会使用常用的初始化方法 <code>-initWithReferenceView:</code> ，因为我们不需要把这个 dynamic animator 关联一个 view ，而是给它关联一个 collection view layout。所以我们使用 <code>-initWithCollectionViewLayout:</code> 这个初始化方法，并把 collection view layout 作为参数传入。这很关键，当的 animator 的 behavior item 的属性应该被更新的时候，它必须能够确保 collection view 的 layout 失效。换句话说，dynamic animator 将会经常使旧的 layout 失效。</p>

<p>我们很快就能看到这些事情是怎么连接起来的，但是在概念上理解 collection view 如何与 dynamic animator 相互作用是很重要的。</p>

<p>Collection view layout 将会为 collection view 中的每个 <code>UICollectionViewLayoutAttributes</code> 添加 behavior（稍后我们会讨论平铺它们）。在将这些 behaviors 添加到 dynamic animator 之后，UIKit 将会向 collection view layout 询问 atrribute 的状态。我们此时可以直接将由 dynamic animator 所提供的 items 返回，而不需要自己做任何计算。Animator 将在模拟时禁用 layout。这会导致 UIKit 再次查询 layout，这个过程会一直持续到模拟满足设定条件而结束。</p>

<p>所以重申一下，layout 创建了 dynamic animator，并且为其中每个 item 的 layout attribute 添加对应的 behaviors。当 collection view 需要 layout 信息时，由 dynamic animator 来提供需要的信息。</p>

<h2>继承 UICollectionViewFlowLayout</h2>

<p>我们将要创建一个简单的例子来展示如何使用一个带 UIkit Dynamic 的 collection view layout。当然，我们需要做的第一件事就是，创建一个数据源去驱动我们的 collection view。我知道以你的能力完全可以独立实现一个数据源，但是为了完整性，我还是提供了一个给你:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@implementation ASHCollectionViewController

static NSString * CellIdentifier = @&quot;CellIdentifier&quot;;

-(void)viewDidLoad 
{
    [super viewDidLoad];
    [self.collectionView registerClass:[UICollectionViewCell class] 
            forCellWithReuseIdentifier:CellIdentifier];
}

-(UIStatusBarStyle)preferredStatusBarStyle 
{
    return UIStatusBarStyleLightContent;
}

-(void)viewDidAppear:(BOOL)animated 
{
    [super viewDidAppear:animated];
    [self.collectionViewLayout invalidateLayout];
}

#pragma mark - UICollectionView Methods

-(NSInteger)collectionView:(UICollectionView *)collectionView 
    numberOfItemsInSection:(NSInteger)section 
{
    return 120;
}

-(UICollectionViewCell *)collectionView:(UICollectionView *)collectionView 
                 cellForItemAtIndexPath:(NSIndexPath *)indexPath 
{
    UICollectionViewCell *cell = [collectionView 
        dequeueReusableCellWithReuseIdentifier:CellIdentifier 
                                  forIndexPath:indexPath];

    cell.backgroundColor = [UIColor orangeColor];
    return cell;
}

@end
</code></pre></div>
<p>我们注意到当 view 第一次出现的时候，这个 layout 是被无效的。这是因为没有用 Storyboard 的结果（使用或不使用 Storyboard，调用 prepareLayout 方法的时机是不同的，苹果在 WWDC 的视频中并没有告诉我们这一点）。所以，当这些视图一出现我们就需要手动使这个 collection view layout 无效。当我们用平铺（后面会详细介绍）的时候，就不需要这样。</p>

<p>现在来创建自定义的 collection view layout 吧，我们需要强引用一个 dynamic animator，并且使用它来驱动我们的 collcetion view layout 的 attribute。我们在实现文件里定义了一个私有属性：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@interface ASHSpringyCollectionViewFlowLayout ()

@property (nonatomic, strong) UIDynamicAnimator *dynamicAnimator;

@end
</code></pre></div>
<p>我们将在 layout 的初始化方法中初始化我们的 dynamic animator。还要设置一些属于父类 <code>UICollectionViewFlowLayout</code> 中的属性:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">- (id)init 
{
    if (!(self = [super init])) return nil;

    self.minimumInteritemSpacing = 10;
    self.minimumLineSpacing = 10;
    self.itemSize = CGSizeMake(44, 44);
    self.sectionInset = UIEdgeInsetsMake(10, 10, 10, 10);

    self.dynamicAnimator = [[UIDynamicAnimator alloc] initWithCollectionViewLayout:self];

    return self;
}
</code></pre></div>
<p>我们将实现的下一个方法是 prepareLayout。我们首先需要调用父类的方法。因为我们是继承 <code>UICollectionViewFlowLayout</code> 类，所以在调用父类的 prepareLayout 方法时，可以使 collection view layout 的各个 attribute 都放置在合适的位置。我们可以依靠父类的这个方法来提供一个默认的排布，并且能够使用 <code>[super layoutAttributesForElementsInRect:visibleRect];</code> 方法得到指定 rect 内的<em>所有</em> item 的 layout attributes。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[super prepareLayout];

CGSize contentSize = self.collectionView.contentSize;
NSArray *items = [super layoutAttributesForElementsInRect:
    CGRectMake(0.0f, 0.0f, contentSize.width, contentSize.height)];
</code></pre></div>
<p>这<em>真的</em>是效率低下的代码。因为我们的 collection view 中可能会有成千上万个 cell，一次性加载所有的 cell 是一个可能会产生难以置信的内存紧张的操作。我们要在一段时间内遍历所有的元素，这也成为耗时的操作。这真的是效率的双重打击！别担心——我们是负责任的开发者，所以我们会很快解决这个问题的。我们先暂时继续使用简单、粗暴的实现方式。</p>

<p>当加载完我们所有的 collection view layout attribute 之后，我们需要检查他们是否都已经被加载到我们的 animator 里了。如果一个 behavior 已经在 animator 中存在，那么我们就不能重新添加，否则就会得到一个非常难懂的运行异常提示:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;UIDynamicAnimator: 0xa5ba280&gt; (0.004987s) in 
&lt;ASHSpringyCollectionViewFlowLayout: 0xa5b9e60&gt; \{\{0, 0}, \{0, 0\}\}: 
body &lt;PKPhysicsBody&gt; type:&lt;Rectangle&gt; representedObject:
[&lt;UICollectionViewLayoutAttributes: 0xa281880&gt; 
index path: (&lt;NSIndexPath: 0xa281850&gt; {length = 2, path = 0 - 0}); 
frame = (10 10; 300 44); ] 0xa2877c0  
PO:(159.999985,32.000000) AN:(0.000000) VE:(0.000000,0.000000) AV:(0.000000) 
dy:(1) cc:(0) ar:(1) rs:(0) fr:(0.200000) re:(0.200000) de:(1.054650) gr:(0) 
without representedObject for item &lt;UICollectionViewLayoutAttributes: 0xa3833e0&gt; 
index path: (&lt;NSIndexPath: 0xa382410&gt; {length = 2, path = 0 - 0}); 
frame = (10 10; 300 44);
</code></pre></div>
<p>如果看到了这个错误，那么这基本表明你添加了两个 behavior 给同一个 <code>UICollectionViewLayoutAttribute</code>，这使得系统不知道该怎么处理。</p>

<p>无论如何，一旦我们已经检查好我们是否已经将 behavior 添加到 dynamic animator 之后，我们就需要遍历每个 collection view layout attribute 来创建和添加新的 dynamic animator：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">if (self.dynamicAnimator.behaviors.count == 0) {
    [items enumerateObjectsUsingBlock:^(id&lt;UIDynamicItem&gt; obj, NSUInteger idx, BOOL *stop) {
        UIAttachmentBehavior *behaviour = [[UIAttachmentBehavior alloc] initWithItem:obj 
                                                                    attachedToAnchor:[obj center]];

        behaviour.length = 0.0f;
        behaviour.damping = 0.8f;
        behaviour.frequency = 1.0f;

        [self.dynamicAnimator addBehavior:behaviour];
    }];
}
</code></pre></div>
<p>这段代码非常简单。我们为每个 item 创建了一个以物体的中心为附着点的 <code>UIAttachmentBehavior</code> 对象。然后又设置了我们的 attachment behavior 的 length 为 0 以便约束这个 cell 能一直以 behavior 的附着点为中心。然后又给 <code>damping</code> 和 <code>frequency</code> 这两个参数设置一个比较合适的值。</p>

<p>这就是 <code>prepareLayout</code>。我们现在需要实现 <code>layoutAttributesForElementsInRect:</code> 和 <code>layoutAttributesForItemAtIndexPath:</code> 这两个方法，UIKit 会调用它们来询问 collection view 每一个 item 的布局信息。我们写的代码会把这些查询交给专门做这些事的 dynamic animator:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">-(NSArray *)layoutAttributesForElementsInRect:(CGRect)rect 
{
    return [self.dynamicAnimator itemsInRect:rect];
}

-(UICollectionViewLayoutAttributes *)layoutAttributesForItemAtIndexPath:(NSIndexPath *)indexPath 
{
    return [self.dynamicAnimator layoutAttributesForCellAtIndexPath:indexPath];
}
</code></pre></div>
<h1>响应滚动事件</h1>

<p>我们目前实现的代码给我们展示的只是一个在正常滑动下只有静态感觉的 <code>UICollectionView</code>，运行起来没什么特别的。看上去很好，但不是真的<em>动态</em>，不是么？</p>

<p>为了使它表现地动态点，我们需要 layout 和 dynamic animator 能够对 collection view 中滑动位置的变化做出反应。幸好这里有个非常适合这个要求的方法 <code>shouldInvalidateLayoutForBoundsChange:</code>。这个方法会在 collection view 的 bound 发生改变的时候被调用，根据最新的 <a href="http://www.objccn.io/issue-3-2/">content offset</a> 调整我们的 dynamic animator 中的 behaviors 的参数。在重新调整这些 behavior 的 item 之后，我们在这个方法中返回 NO；因为 dynamic animator 会关心 layout 的无效问题，所以在这种情况下，它不需要去主动使其无效：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    -(BOOL)shouldInvalidateLayoutForBoundsChange:(CGRect)newBounds 
    {
        UIScrollView *scrollView = self.collectionView;
        CGFloat delta = newBounds.origin.y - scrollView.bounds.origin.y;

        CGPoint touchLocation = [self.collectionView.panGestureRecognizer locationInView:self.collectionView];

        [self.dynamicAnimator.behaviors enumerateObjectsUsingBlock:^(UIAttachmentBehavior *springBehaviour, NSUInteger idx, BOOL *stop) {
            CGFloat yDistanceFromTouch = fabsf(touchLocation.y - springBehaviour.anchorPoint.y);
            CGFloat xDistanceFromTouch = fabsf(touchLocation.x - springBehaviour.anchorPoint.x);
            CGFloat scrollResistance = (yDistanceFromTouch + xDistanceFromTouch) / 1500.0f;

            UICollectionViewLayoutAttributes *item = springBehaviour.items.firstObject;
            CGPoint center = item.center;
            if (delta &lt; 0) {
                center.y += MAX(delta, delta*scrollResistance);
            }
            else {
                center.y += MIN(delta, delta*scrollResistance);
            }
            item.center = center;

            [self.dynamicAnimator updateItemUsingCurrentState:item];
        }];

        return NO;
    }
</code></pre></div>
<p>让我们仔细查看这个代码的细节。首先我们得到了这个 scroll view（就是我们的 collection view ），然后计算它的 content offset 中 y 的变化（在这个例子中，我们的 collection view 是垂直滑动的）。一旦我们得到这个增量，我们需要得到用户接触的位置。这是非常重要的，因为我们希望离接触位置比较近的那些物体能移动地更迅速些，而离接触位置比较远的那些物体则应该滞后些。</p>

<p>对于 dynamic animator 中的每个 behavior，我们将接触点到该 behavior 物体的 x 和 y 的距离之和除以 1500，1500 是我根据经验设的。分母越小，这个 collection view 的的交互就越有弹簧的感觉。一旦我们拿到了这个“滑动阻力”的值，我们就可以用它的增量乘上 <code>scrollResistance</code> 这个变量来指定这个 behavior 物体的中心点的 y 值。最后，我们在滑动阻力大于增量的情况下对增量和滑动阻力的结果进行了选择（这意味着物体开始往错误的方向移动了）。在本例我们用了这么大的分母，那么这种情况是不可能的，但是在一些更具弹性的 collection view layout 中还是需要注意的。</p>

<p>就是这么一回事。以我的经验，这个方法对多达几百个物体的 collection view 来说也是是适用的。超过这个数量的话，一次性加载所有物体到内存中就会变成很大的负担，并且在滑动的时候就会开始卡顿了。</p>

<p><img src="http://img.objccn.io/issue-5/springyCollectionView.gif" alt="Springy Collection View"></p>

<h2>平铺（Tiling）你的 Dynamic Behaviors 来优化性能</h2>

<p>当你的 collection view 中只有几百个 cell 的时候，他运行的很好，但当数据源超过这个范围的时候会发生什么呢？或者在运行的时你不能预测你的数据源有多大呢？我们的简单粗暴的方法就不管用了。</p>

<p>除了在 <code>prepareLayout</code> 中加载<em>所有</em>的物体，如果我们能<em>更聪明地</em>知道哪些物体会加载那该多好啊。是的，就是仅加载显示的和即将显示的物体。这正是我们要采取的办法。</p>

<p>我们需要做的第一件事就是是跟踪 dynamic animator 中的所有 behavior 物体的 index path。我在 collection view 中添加一个属性来做这件事:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@property (nonatomic, strong) NSMutableSet *visibleIndexPathsSet;
</code></pre></div>
<p>我们用 set 是因为它具有常数复杂度的查找效率，并且我们<em>经常</em>地查找 <code>visibleIndexPathsSet</code> 中是否已经包含了某个 index path。</p>

<p>在我们实现全新的 <code>prepareLayout</code> 方法之前——有一个问题就是什么是<strong>平铺 behavior</strong> —— 理解平铺的意思是非常重要的。当我们平铺behavior 的时候，我们会在这些 item 离开 collection view 的可视范围的时候删除对应的 behavior，在这些 item 进入可视范围的时候又添加对应的 behavior。这是一个大麻烦：我们需要在<em>滚动中</em>创建新的 behavior。这就意味着让人觉得创建它们就好像它们本来就已经在 dynamic animator 里了一样，并且它们是在 <code>shouldInvalidateLayoutForBoundsChange:</code> 方法被修改的。</p>

<p>因为我们是在滚动中创建这些新的 behavior，所以我们需要维持现在 collection view 的一些状态。尤其我们需要跟踪最近一次我们 <code>bound</code> 变化的增量。我们会在滚动时用这个状态去创建我们的 behavior：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@property (nonatomic, assign) CGFloat latestDelta;
</code></pre></div>
<p>添加完这个 property 后，我们将要在 <code>shouldInvalidateLayoutForBoundsChange:</code> 方法中添加下面这行代码：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">self.latestDelta = delta;
</code></pre></div>
<p>这就是我们需要修改我们的方法来响应滚动事件。我们的这两个方法是为了将 collection view 中 items 的 layout 信息传给 dynamic animator，这种方式没有变化。事实上，当你的 collection view 实现了 dynamic animator 的大部分情况下，都需要实现我们上面提到的两个方法 <code>layoutAttributesForElementsInRect:</code> 和 <code>layoutAttributesForItemAtIndexPath:</code>。</p>

<p>这里最难懂的部分就是平铺机制。我们将要完全重写我们的 prepareLayout。</p>

<p>这个方法的第一步是将那些物体的 index path 已经不在屏幕上显示的 behavior 从 dynamic animator 上删除。第二步是添加那些即将显示的物体的 behavior。</p>

<p>让我们先看一下第一步。</p>

<p>像以前一样，我们要调用 <code>super prepareLayout</code>，这样我们就能依赖父类 <code>UICollectionViewFlowLayout</code> 提供的默认排布。还像以前一样，我们通过父类获取一个矩形内的所有元素的 layout attribute。不同的是我们不是获取整个 collection view 中的元素属性，而只是获取显示范围内的。</p>

<p>所以我们需要计算这个显示矩形。但是别着急！有件事要记住。我们的用户可能会非常快地滑动 collection view，导致了 dynamic animator 不能跟上，所以我们需要稍微扩大显示范围，这样就能包含到那些将要显示的物体了。否则，在滑动很快的时候就会出现频闪现象了。让我们计算一下显示范围:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">CGRect originalRect = (CGRect){.origin = self.collectionView.bounds.origin, .size = self.collectionView.frame.size};
CGRect visibleRect = CGRectInset(originalRect, -100, -100);
</code></pre></div>
<p>我确信在实际显示矩形上的每个方向都扩大100个像素对我的 demo 来说是可行的。仔细查看这些值是否适合你们的 collection view，尤其是当你们的 cell 很小的情况下。</p>

<p>接下来我们就需要收集在显示范围内的 collection view layout attributes。还有它们的 index paths:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NSArray *itemsInVisibleRectArray = [super layoutAttributesForElementsInRect:visibleRect];

NSSet *itemsIndexPathsInVisibleRectSet = [NSSet setWithArray:[itemsInVisibleRectArray valueForKey:@&quot;indexPath&quot;]];
</code></pre></div>
<p>注意我们是在用一个 NSSet。这是因为它具有常数复杂度的查找效率，并且我们经常的查找 <code>visibleIndexPathsSet</code> 是否已经包含了某个 index path:</p>

<p>接下来我们要做的就是遍历 dynamic animator 的 behaviors，过滤掉那些已经在 <code>itemsIndexPathsInVisibleRectSet</code> 中的 item。因为我们已经过滤掉我们的 behavior，所以我们将要遍历的这些 item 都是不在显示范围里的，我们就可以将这些 item 从 animator 中删除掉（连同 <code>visibleIndexPathsSet</code> 属性中的 index path）:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NSPredicate *predicate = [NSPredicate predicateWithBlock:^BOOL(UIAttachmentBehavior *behaviour, NSDictionary *bindings) {
    BOOL currentlyVisible = [itemsIndexPathsInVisibleRectSet member:[[[behaviour items] firstObject] indexPath]] != nil;
    return !currentlyVisible;
}]
NSArray *noLongerVisibleBehaviours = [self.dynamicAnimator.behaviors filteredArrayUsingPredicate:predicate];

[noLongerVisibleBehaviours enumerateObjectsUsingBlock:^(id obj, NSUInteger index, BOOL *stop) {
    [self.dynamicAnimator removeBehavior:obj];
    [self.visibleIndexPathsSet removeObject:[[[obj items] firstObject] indexPath]];
}];
</code></pre></div>
<p>下一步就是要得到<em>新</em>出现 item 的 <code>UICollectionViewLayoutAttributes</code> 数组——那些 item 的 index path 在 <code>itemsIndexPathsInVisibleRectSet</code> 而不在 <code>visibleIndexPathsSet</code>：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NSPredicate *predicate = [NSPredicate predicateWithBlock:^BOOL(UICollectionViewLayoutAttributes *item, NSDictionary *bindings) {
    BOOL currentlyVisible = [self.visibleIndexPathsSet member:item.indexPath] != nil;
    return !currentlyVisible;
}];
NSArray *newlyVisibleItems = [itemsInVisibleRectArray filteredArrayUsingPredicate:predicate];
</code></pre></div>
<p>一旦我们有新的 layout attribute 出现，我就可以遍历他们来创建新的 behavior，并且将他们的 index path 添加到 <code>visibleIndexPathsSet</code> 中。首先，无论如何，我都需要获取到用户手指触碰的位置。如果它是 <code>CGPointZero</code> 的话，那就表示这个用户没有在滑动 collection view，这时我就<em>假定</em>我们不需要在滚动时创建新的 behavior 了：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">CGPoint touchLocation = [self.collectionView.panGestureRecognizer locationInView:self.collectionView];
</code></pre></div>
<p>这是一个潜藏危险的假定。如果用户很快地滑动了 collection view 之后释放了他的手指呢？这个 collection view 就会一直滚动，但是我们的方法就不会在滚动时创建新的 behavior 了。但幸运的是，那也就意味这时 scroll view 滚动太快很难被注意到！好哇！但是，对于那些拥有大型 cell 的 collection view 来说，这仍然是个问题。那么在这种情况下，就需要增加你的可视范围的 bounds 来加载更多物体以解决这个问题。</p>

<p>现在我们需要枚举我们刚显示的 item，为他们创建 behavior，再将他们的 index path 添加到 <code>visibleIndexPathsSet</code>。我们还需要在滚动时做些<a href="http://www.youtube.com/watch?v=gENVB6tjq_M">数学运算</a>来创建 behavior：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[newlyVisibleItems enumerateObjectsUsingBlock:^(UICollectionViewLayoutAttributes *item, NSUInteger idx, BOOL *stop) {
    CGPoint center = item.center;
    UIAttachmentBehavior *springBehaviour = [[UIAttachmentBehavior alloc] initWithItem:item attachedToAnchor:center];

    springBehaviour.length = 0.0f;
    springBehaviour.damping = 0.8f;
    springBehaviour.frequency = 1.0f;

    if (!CGPointEqualToPoint(CGPointZero, touchLocation)) {
        CGFloat yDistanceFromTouch = fabsf(touchLocation.y - springBehaviour.anchorPoint.y);
        CGFloat xDistanceFromTouch = fabsf(touchLocation.x - springBehaviour.anchorPoint.x);
        CGFloat scrollResistance = (yDistanceFromTouch + xDistanceFromTouch) / 1500.0f;

        if (self.latestDelta &lt; 0) {
            center.y += MAX(self.latestDelta, self.latestDelta*scrollResistance);
        }
        else {
            center.y += MIN(self.latestDelta, self.latestDelta*scrollResistance);
        }
        item.center = center;
    }

    [self.dynamicAnimator addBehavior:springBehaviour];
    [self.visibleIndexPathsSet addObject:item.indexPath];
}];
</code></pre></div>
<p>大部分代码看起来还是挺熟悉的。大概有一半是来自没有实现平铺的 <code>prepareLayout</code>。另一半是来自 <code>shouldInvalidateLayoutForBoundsChange:</code> 这个方法。我们用 latestDelta 这个属性来表示 <code>bound</code> 变化的增量，适当地调整 <code>UICollectionViewLayoutAttributes</code> 使这些 cell 表现地就像被 attachment behavior “拉”着一样。</p>

<p>就这样就完成了，真的！我已经在真机上测试过显示上千个 cell 的情况了，它运行地非常完美。<a href="https://github.com/objcio/issue-5-springy-collection-view">去试试吧</a>。</p>

<h2>超越瀑布流布局</h2>

<p>一般来说，当我们使用 <code>UICollectionView</code> 的时候，继承 <code>UICollectionViewFlowLayout</code> 会比直接继承 <code>UICollectionViewLayout</code> 更容易。这是因为 <em>flow</em> layout 会为我们做很多事。然而，瀑布流布局是严格基于它们的尺寸一个接一个的展现出来。如果你有一个布局不能适应这个标准怎么办？好的，如果你已经尝试用 <code>UICollectionViewFlowLayout</code> 来适应，而且你很确定它不能很好运行，那么就应该抛弃 <code>UICollectionViewFlowLayout</code> 这个定制性比较弱的子类，而应该直接在 <code>UICollectionViewLayout</code> 这个基类上进行定制。</p>

<p>这个原则在处理 UIKit Dynamic 时也是适用的。</p>

<p>让我们先创建 <code>UICollectionViewLayout</code> 的子类。当继承 <code>UICollectionViewLayout</code> 的时候需要实现 <code>collectionViewContentSize</code> 方法，这点非常重要。否则这个 collection view 就不知道如果去显示自己，也不会有显示任何东西。因为我们想要 collection view 不能滚动，所以这里要返回 collection view 的 frame 的 size，减去它的 <code>contentInset.top</code>：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">-(CGSize)collectionViewContentSize 
{
    return CGSizeMake(self.collectionView.frame.size.width, 
        self.collectionView.frame.size.height - self.collectionView.contentInset.top);
}
</code></pre></div>
<p>在这个（有点教学式）的例子中，我们的 collection view <em>总是会以零个cell开始</em>，物体通过 <code>performBatchUpdates:</code> 这个方法添加。这就意味着我们必须使用 <code>-[UICollectionViewLayout prepareForCollectionViewUpdates:]</code> 这个方法来添加我们的 behavior（即这个 collection view 的数据源总是以零开始）。</p>

<p>除了给各个 item 添加 attachment behavior 外，我们还将保留另外两个 behavior：重力和碰撞。对于添加在这个 collection view 中的每个 item 来说，我们必须把这些 item 添加到我们的碰撞和 attachment behavior 中。最后一步就是设置这些 item 的初始位置为屏幕外的某些地方，这样就有被 attachment behavior 拉入到屏幕内的效果了:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">-(void)prepareForCollectionViewUpdates:(NSArray *)updateItems
{
    [super prepareForCollectionViewUpdates:updateItems];

    [updateItems enumerateObjectsUsingBlock:^(UICollectionViewUpdateItem *updateItem, NSUInteger idx, BOOL *stop) {
        if (updateItem.updateAction == UICollectionUpdateActionInsert) {
            UICollectionViewLayoutAttributes *attributes = [UICollectionViewLayoutAttributes 
                layoutAttributesForCellWithIndexPath:updateItem.indexPathAfterUpdate];

            attributes.frame = CGRectMake(CGRectGetMaxX(self.collectionView.frame) + kItemSize, 300, kItemSize, kItemSize);

            UIAttachmentBehavior *attachmentBehaviour = [[UIAttachmentBehavior alloc] initWithItem: attributesaachedToAnchor:attachmentPoint];
            attachmentBehaviour.length = 300.0f;
            attachmentBehaviour.damping = 0.4f;
            attachmentBehaviour.frequency = 1.0f;
            [self.dynamicAnimator addBehavior:attachmentBehaviour];

            [self.gravityBehaviour addItem:attributes];
            [self.collisionBehaviour addItem:attributes];
        }
    }];
}
</code></pre></div>
<p><img src="http://img.objccn.io/issue-5/newtonianCollectionView.gif" alt="Demo"></p>

<p>删除就有点复杂了。我们希望这些物体有“掉落”的效果而不是简单的消失。这就不仅仅是从 collection view 中删除个 cell 这么简单了，因为我们希望在它离开了屏幕之前还是保留它。我已经在代码中实现了这样的效果，但是做法有点取巧。</p>

<p>基本上我们要做的是在 layout 中提供一个方法，在它删除 attachment behavior 两秒之后，将这个 cell 从 collection view 中删除。我们希望在这段时间里，这个 cell 能掉出屏幕，但是这不一定会发生。如果没有发生，也没关系。只要淡出就行了。然而，我们必须保证在这两秒内既没有新的 cell 被添加，也没有旧的 cell 被删除。（我说了有点取巧。）</p>

<p>欢迎提交 pull request。</p>

<p>这个方法是有局限性的。我将 cell 数量的上限设为 10，但是即使这样，在像 iPad2 这样比较旧的设备中，动画就会运行地很慢。当然，这个例子只是为了展示如何模拟有趣的动力学的一个方法——它并不是一个可以解决任何问题的万金油。你个人在实践中如何来进行模拟，包括性能等各个方面，都取决于你自己了。</p>

<hr>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-02-19T00:00:00+08:00"><a href="http://morisunshine.com/ruby/make_your_own_gem/">February 19, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ruby/make_your_own_gem/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ruby/make_your_own_gem/" rel="bookmark" title="制作自己的Gem" itemprop="url">制作自己的Gem</a></h1>
    
  </header>
  <div class="entry-description">RubyGems是一个方便而强大的Ruby程序包管理器，Ruby的第三方插件是用gem方式来管理，非常容易发布和共享，一个简单的命令就可以安装上第三方的扩展库。特点：能远程安装包，包之间依赖关系的管理，简单可靠的卸载，查询机制，能查询本地和远程服务器的包信息，能保持一个包的不同版本，基于Web的查看接口，能查看你安装的gem的信息。</div>
  <div class="entry-content">
    <div class="full-text"><p>&nbsp;<a href="#introduce"><strong>什么是Gem？</strong></a><br>
&nbsp;<a href="#first_gem"><strong>第一个Gem</strong></a><br>
&nbsp;<a href="#include_more_files"><strong>包含更多文件</strong></a><br>
&nbsp;<a href="#adding_an_executable"><strong>添加可执行文件</strong></a><br>
&nbsp;<a href="#writing_tests"><strong>测试</strong></a><br>
&nbsp;<a href="#documenting_your_code"><strong>文档</strong></a>  </p>

<p><a id='introduce' name='introduce'> </a></p>

<h2>什么是Gem?</h2>

<p>RubyGems是一个方便而强大的Ruby程序包管理器，Ruby的第三方插件是用gem方式来管理，非常容易发布和共享，一个简单的命令就可以安装上第三方的扩展库。特点：能远程安装包，包之间依赖关系的管理，简单可靠的卸载，查询机制，能查询本地和远程服务器的包信息，能保持一个包的不同版本，基于Web的查看接口，能查看你安装的gem的信息。</p>

<hr>

<p><a id='first_gem' name='first_gem'> </a></p>

<h2>第一个Gem</h2>

<p>我们要创建一个名叫<code>moondemo</code>的gem，首先，就要创建一个名字为<code>moondemo_yourname</code>的目录，这个是为了后面的发布，如果你想发布的话，就要检查一下你的gem名字是否已经被人使用了，如果已经被人使用，那就要换个名字了。<br>
然后这个目录里的基本文件结构应该是这样的。 </p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">tree</span>  
<span class="o">.</span>  
<span class="err">├──</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>    
<span class="err">├──</span> <span class="n">lib</span>  
<span class="err">│  </span> <span class="err">└──</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">rb</span>  
</code></pre></div>
<p>gem中的代码被放在<code>lib</code>目录中，这里有个约定就是<code>lib</code>中必须有个和gem同名的ruby文件，这样当<code>require &#39;moondemo&#39;</code>运行的时候，这个gem就会被加载，这个文件就是负责配置你的gem的代码和API。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">cat</span> <span class="n">lib</span><span class="o">/</span><span class="n">moondemo</span><span class="o">.</span><span class="n">rb</span>
<span class="k">class</span> <span class="n">moondemo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hi</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello world!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>而<code>.gemspec</code>文件是定义了这个gem的信息，比如是这个gem的功能，作者等，并且当这个gem发布的时候，会将这些信息显示到这个gem的主页上(就像<a href="http://rubygems.org/gems/jekyll">jekyll</a>)。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">cat</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s1">&#39;moondemo&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">date</span>        <span class="o">=</span> <span class="s1">&#39;2014-02-19&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="s2">&quot;moondemo!&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;A simple hello world gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;sheldon huang&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="s1">&#39;allenwenzhou@gmail.com&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">files</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib/moondemo.rb&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span>
    <span class="s1">&#39;http://rubygems.org/gems/moondemo&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">license</span>       <span class="o">=</span> <span class="s1">&#39;MIT&#39;</span>
<span class="k">end</span>
</code></pre></div>
<p>这里有很多选项，一看名字就知道他们是要代表什么内容的，如果你还想知道更多就看一些这个<a href="http://guides.rubygems.org/specification-reference/">文档</a></p>

<p>当我们创建完成了一个.gemspec，就可以编译出一个gem了，是不是有点小激动啊。但如果想要测试它就必须要在本地安装编译好的gem。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">build</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>
  <span class="no">Successfully</span> <span class="n">built</span> <span class="no">RubyGem</span>
  <span class="ss">Name</span><span class="p">:</span> <span class="n">moondemo</span>
  <span class="ss">Version</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="ss">File</span><span class="p">:</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>

<span class="err">➜</span> <span class="n">gem</span> <span class="n">install</span> <span class="o">.</span><span class="n">/moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>
<span class="no">Successfully</span> <span class="n">installed</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Parsing</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Installing</span> <span class="n">ri</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="mi">1</span> <span class="n">gem</span> <span class="n">installed</span>
</code></pre></div>
<p>上面这些步骤，只能是在本地已经装好了我们自己的gem，但还没有使用它，
我们需要<code>require</code>这个gem然后根据自己定义的方法来使用它。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">irb</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span>
<span class="no">Hello</span> <span class="n">world!</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div>
<p>现在就可以将你的gem发布到Ruby社区上了，当在发布之前需要将你的帐号安装在电脑上，如果你在RubyGems.org上注册了帐号，那就只需要输入一个命令,再输入自己的密码就可以了</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="err">你的帐号名</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">rubygems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">api_key</span><span class="o">.</span><span class="n">yaml</span> <span class="o">&gt;</span> <span class="o">~</span><span class="sr">/.gem/</span><span class="n">credentials</span><span class="p">;</span> <span class="n">chmod</span> <span class="mo">0600</span> <span class="o">~</span><span class="sr">/.gem/</span><span class="n">credentials</span>

<span class="no">Enter</span> <span class="n">host</span> <span class="n">password</span> <span class="k">for</span> <span class="n">user</span> <span class="s1">&#39;你的帐号名&#39;</span><span class="p">:</span>
</code></pre></div>
<p>一旦你的用户名已经被安装了，就可以直接发布你的gem了。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">push</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>
<span class="no">Pushing</span> <span class="n">gem</span> <span class="n">to</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">rubygems</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="no">Successfully</span> <span class="n">registered</span> <span class="ss">gem</span><span class="p">:</span> <span class="n">moondemo</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>很快的，你的gem就可以被任何人使用了</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">moondemo</span>
<span class="no">Successfully</span> <span class="n">installed</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Parsing</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="mi">1</span> <span class="n">gem</span> <span class="n">installed</span>
</code></pre></div>
<p>用Ruby和RubyGems来分享代码是不是很简单。</p>

<hr>

<p><a id='include_more_files' name='include_more_files'> </a></p>

<h2>包含更多文件</h2>

<p>我们以后代码当然不会这么简单，如果代码变得非常多了之后，该怎么办呢，当然是要是要将代码分到不同的文件中了。<br>
比如我们想在刚才的gem中添加根据不同语言来输出不同语言的&quot;Hello world&quot;。<br>
我们就可以添加一个<code>Translator</code>文件，刚才提到过，gem的根文件是负责加载代码的，所以其他的功能的文件就需要放在<code>lib</code>中和gem同名的目录中，我们可以这样分:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜ tree
.
├── lib
│   ├── moondemo
│   │   └── translator.rb
│   └── moondemo.rb
├── moondemo-0.0.1.gem
</code></pre></div>
<p><code>Translator</code>中的内容是:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Translator</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="vi">@language</span> <span class="o">=</span> <span class="n">language</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hi</span>
    <span class="k">case</span> <span class="vi">@language</span>
      <span class="k">when</span> <span class="s2">&quot;chinese&quot;</span>
        <span class="s2">&quot;你好，世界!&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;Hello world!&quot;</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>所以接下来，<code>moondemo.rb</code>中需要加载<code>Translator</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MoonDemo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hi</span><span class="p">(</span><span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="no">Translator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="n">translator</span><span class="o">.</span><span class="n">hi</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>注意:每次新建了一个目录或者文件，都不要忘记加到.gemspec文件中，就像这样</em></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Sheldon&quot;</span><span class="o">]</span>
 <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="s1">&#39;allenwenzhou@gmial.com&#39;</span>
 <span class="n">s</span><span class="o">.</span><span class="n">files</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib/moondemo.rb&quot;</span><span class="p">,</span><span class="s2">&quot;lib/moondemo/translator.rb&quot;</span><span class="o">]</span>
</code></pre></div>
<p><em>如果没有上面的修改的话，这个新建的目录是不会被加载到已安装的gem里的</em></p>

<p>让我们再运行一篇</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">irb</span> <span class="o">-</span><span class="no">Ilib</span> <span class="o">-</span><span class="n">rmoondemo</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;Hello world!&quot;</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;你好，世界!&quot;</span>
</code></pre></div>
<p>这里我们使用了一个新的命令行<code>-Ilib</code>,通常RubyGems会为你包含了<code>lib</code>路径，所以很多时候，我们不需要去考虑配置它们的加载路径，但是，如果你把代码运行在RubyGems的项目之外，你就要自己去配置这些了。</p>

<p>如果你添加了一些新的文件到你的gem中，那么你一定要记住在发布之前将这些文件添加到你的<code>.gemspec</code>的<code>files</code>数组中。这样很麻烦是么，所以很多人就选择用<a href="http://docs.seattlerb.org/hoe/">Hoe</a>,<a href="https://github.com/technicalpickles/jeweler">Jeweler</a>,<a href="http://rake.rubyforge.org/classes/Rake/GemPackageTask.html">Rake</a>,<a href="http://railscasts.com/episodes/245-new-gem-with-bundler">Bundler</a>或者用<a href="https://github.com/wycats/newgem-template/blob/master/newgem.gemspec">动态的gemspec</a>来实现自动化。</p>

<p>添加更多的目录也都是按照上面一样的步骤，我们要将我们的文件结构分布合理，这样对于我们以后的维护和未来开发人员来说就不会是一件头疼的事儿了。</p>

<p><a id='adding_an_executable' name='adding_an_executable'> </a></p>

<h2>添加可执行文件</h2>

<p>gem除了可以提供Ruby代码库外，还可以在你的可执行文件路径里提供很多可执行可执行文件文件。可能最有名的就是<code>rake</code>，
添加一个可执行可执行可执行文件文件其实很简单，你只需要将你的可执行文件放在你的gem的<code>bin</code>目录下，然后在将这个文件添加到<code>.gemspec</code>文件中<code>executables</code>的列表里就可以了，让我们试一下:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  mkdir bin
➜  touch bin/moondemo
➜  chmod a+x bin/moondemo
</code></pre></div>
<p>这个可执行文件只需要在开头用<a href="http://www.catb.org/jargon/html/S/shebang.html">shebang</a>来表明这是用程序来运行的，下面就是这个可执行文件的内容:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>
<span class="nb">puts</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</code></pre></div>
<p>这个可执行文件的内容很简单，它只是加载了moondemo这个gem，然后在命令行中通过输入一个参数来判断是用哪个国家的语言来说&quot;hello, world&quot;。下面就是运行的例子:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  ruby -Ilib ./bin/moondemo
Hello world!
➜  ruby -Ilib ./bin/moondemo chinese
你好，世界!
</code></pre></div>
<p>最后，我们要将这个可执行文件添加到<code>.gemspec</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">s</span><span class="o">.</span><span class="n">executables</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;moondemo&#39;</span>
</code></pre></div>
<p>更新你的gem，上传到官网上，这样你就可以在命令行中有自己的命令了，是不是很帅啊。这里要提醒一下，上传新的gem时，要记得修改<code>.gemspec</code>中的版本号。详情看<a href="http://guides.rubygems.org/patterns/#semantic-versioning">这儿</a></p>

<p>在看一下用我们自己定义的命令行吧:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  ~  moondemo
Hello world!
➜  ~  moondemo chinese
你好，世界!
</code></pre></div>
<p>世界在向我们招手呢。哈哈哈~~~</p>

<p><a id='writing_tests' name='writing_tests'> </a></p>

<h1>测试</h1>

<p>测试我们的gem是非常重要的，它不仅保证了这个gem是正常的，也保证了别人能知道你的gem是正常的。当我们评价一个gem的时候，很多Ruby开发者会倾向于通过查看测试用例来做为主要依据。</p>

<p>Gems是支持将测试文件添加到程序包中的，所以当gem被下载了之后，我们可以直接运行测试用例。这里有个帮助我们如何在不同框架和解释器下写测试用例的社区叫<a href="http://test.rubygems.org/">GemTesters</a>
总而言之:去测试我们的Gem吧！啥都别想了！</p>

<p><code>Test::Unit</code>是Ruby的自带测试框架。这里有很多<a href="https://github.com/seattlerb/minitest/blob/master/README.txt">教程</a>，当然还是有很多其他的测试框架，<a href="http://rspec.info/">RSpec</a>就是比较有名的一个，是不是迫不及待，让我们测试吧！</p>

<p>我们需要在原来的基础上再添加一些文件，一个名为<code>Rakefile</code>的文件和一个名为<code>test</code>的目录:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">.
├── Rakefile
├── bin
│   └── moondemo
├── lib
│   ├── moondemo
│   │   └── translator.rb
│   └── moondemo.rb
├── moondemo-0.0.1.gem
├── moondemo.gemspec
├── npm-debug.log
└── <span class="nb">test</span>
    └── test_moondemo.rb
</code></pre></div>
<p><code>Rakefile</code>文件是为了实现自动化的测试:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rake/testtask&#39;</span>

<span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="o">.</span><span class="n">libs</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;test&#39;</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s2">&quot;Run tests&quot;</span>
<span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="ss">:test</span>
<span class="o">~</span>
</code></pre></div>
<p>下面就是一个简单的测试用例了:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>

<span class="k">class</span> <span class="nc">MoonDemoTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_english_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;Hello world!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_any_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;Hello world!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;ruby&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_spanish_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;你好，世界!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>最后，让我们运行这个测试:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  rake <span class="nb">test</span>
Run options:

<span class="c"># Running tests:</span>

Finished tests in 0.006151s, 487.7256 tests/s, 487.7256 assertions/s.
<span class="m">3</span> tests, <span class="m">3</span> assertions, <span class="m">0</span> failures, <span class="m">0</span> errors, <span class="m">0</span> skips
</code></pre></div>
<p>很好，全部都通过了！</p>

<p><a id='documenting_your_code' name='documenting_your_code'> </a></p>

<h1>文档</h1>

<p>文档和测试是一样重要的，大部分gem都是用RDoc来生成文档的，这里有很多<a href="http://docs.seattlerb.org/rdoc/RDoc/Markup.html">教程</a>.
很简单，先切换到gem的根目录下，再命令行中输入<code>rdoc</code>，你就会发现多出了一个名为<code>doc</code>的目录，里面就是我们的文档了，当然你可以自己再进行一些调整。
除了RDoc呢，我们还有另外的选择<a href="http://yardoc.org/">YARD</a>，当我们发布了gem的时候呢，<a href="http://rubydoc.info/">RubyDoc.info</a>会根据你的gem自动生成YARDocs，并且它是可以向下兼容RDoc。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-02-15T00:00:00+08:00"><a href="http://morisunshine.com/hacker/my_first_blog/">February 15, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/hacker/my_first_blog/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/hacker/my_first_blog/" rel="bookmark" title="第一篇博客" itemprop="url">第一篇博客</a></h1>
    
  </header>
  <div class="entry-description">果然生命在于折腾啊，折腾完之后，就会发现之前觉得挺难的事其实也没什么大不了，比如弄这个博客，以前对技术牛人的评判标准就是有个自己域名的博客，崇拜之情如黄河泛滥不可收拾，当自己有勇气去搭建一个的时侯，发现原来这么简单，只要买个域名就可以了，当然那些有些博客是很牛的，但对我来说，这样简单的博客就是我想要的，而内容才是博客最重要的地方。</div>
  <div class="entry-content">
    <div class="full-text"><p>果然生命在于折腾啊，折腾完之后，就会发现之前觉得挺难的事其实也没什么大不了，比如弄这个博客，以前对技术牛人的评判标准就是有个自己域名的博客，崇拜之情如黄河泛滥不可收拾，当自己有勇气去搭建一个的时侯，发现原来这么简单，只要买个域名就可以了，当然那些有些博客是很牛的，但对我来说，这样简单的博客就是我想要的，而内容才是博客最重要的地方。</p>

<p>至于我会在博客里写什么？在这个问题上，没有很明确的限制，希望它是我成长的记事本，无论是生活的哪个方面。我相信人的一生是一个漫长积累的过程，我希望能在这里见证这个过程。也可以理解为娱乐自己。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2013-07-14T00:00:00+08:00"><a href="http://morisunshine.com/ios/iOS_Decorator/">July 14, 2013</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/iOS_Decorator/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/iOS_Decorator/" rel="bookmark" title="iOS设计模式学习---装饰模式" itemprop="url">iOS设计模式学习---装饰模式</a></h1>
    
  </header>
  <div class="entry-description">装饰模式（Decorator），动态地为一个对象添加额外的职责，是继承的替代方案，属于结构型模式。通过装饰模式扩展对象的功能比继承子类方式更灵活，使用继承子类的方式，是在编译时静态决定的，即编译时绑定，而且所有的子类都会继承相同的行为。然而，如果使用组合的方式扩展对象的行为，就可以在运行时动态地进行扩展，将来如果需要也可以动态的撤销，而不会影响原类的行为。</div>
  <div class="entry-content">
    <div class="full-text"><h2>定义</h2>

<p>装饰模式（Decorator），动态地为一个对象添加额外的职责，是继承的替代方案，属于结构型模式。通过装饰模式扩展对象的功能比继承子类方式更灵活，使用继承子类的方式，是在编译时静态决定的，即编译时绑定，而且所有的子类都会继承相同的行为。然而，如果使用组合的方式扩展对象的行为，就可以在运行时动态地进行扩展，将来如果需要也可以动态的撤销，而不会影响原类的行为。<br>
<img src="/images/2013-7-14.jpg" alt="图片">  </p>

<h2>实例</h2>

<p>接下来，通过Object-C来实践一下，我设想一个场景，用Decorator模式来实现一下对某个手机的GPS和蓝牙功能扩展
首先，我们需要一个手机的接口或者抽象类，我这里就用抽象类来实现，代码如下：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">AbstractCellPhone</span> : <span class="bp">NSObject</span>
<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">callNumber</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">sendMessage</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div><div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;AbstractCellPhone.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">AbstractCellPhone</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">callNumber</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">@&quot;phone call somebody&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">sendMessage</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">@&quot;phone send a message to somebody&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div>
<p>AbstractCellPhone也就是结构图中的Component，然后，我再来实现Nokia和Moto的手机类，这类要继承AbstractCellPhone，也就是图中ConcreteComponent类要继承Component，实现代码如下：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;AbstractCellPhone.h&quot;   </span>
<span class="k">@interface</span> <span class="nc">NokiaPhone</span> : <span class="nc">AbstractCellPhone</span>
<span class="k">@end</span>
</code></pre></div><div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;NokiaPhone.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">NokiaPhone</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">callNumber</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">@&quot;NokiaPhone call somebody&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">sendMessage</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">@&quot;NokiaPhone send Message to Somebody&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>接下来我需要一个Decorator接口或者抽象类，实现代码如下：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;AbstractCellPhone.h&quot;</span>

<span class="k">@interface</span> <span class="nc">Decorator</span> : <span class="nc">AbstractCellPhone</span>
<span class="p">{</span>
<span class="k">@protected</span> <span class="n">AbstractCellPhone</span> <span class="o">*</span><span class="n">abstractCellPhone</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">SetComponents:</span><span class="p">(</span><span class="n">Components</span><span class="o">*</span><span class="p">)</span><span class="nv">component</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div><div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;Decorator.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">Decorator</span>
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">SetComponents:</span><span class="p">(</span><span class="n">Components</span><span class="o">*</span><span class="p">)</span><span class="nv">component</span><span class="p">{</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">component</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">callNumber</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">components</span><span class="p">.</span><span class="n">callNumber</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">sendMessage</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">components</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div>
<p>正如结构图中，这个Decorator即继承了AbstractCellPhone，又包含了一个私有的AbstractCellPhone的对象。这样做的意义是：Decorator类又使用了另外一个Component类。我们可以使用一个或多个Decorator对象来“装饰”一个Component对象，且装饰后的对象仍然是一个Component对象。在下来，我要实现GSP和蓝牙的功能扩展，它们要继承自Decorator，代码如下：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;Decorator.h&quot;</span>

<span class="k">@interface</span> <span class="nc">DecoratorGPS</span> : <span class="nc">Decorator</span>

<span class="k">@end</span>
</code></pre></div><div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &quot;DecoratorGPS.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">DecoratorGPS</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">callNumber</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ with GPS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">super</span> <span class="n">callNumber</span><span class="p">]];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">sendMessage</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%@ with GPS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">super</span> <span class="n">sendMessage</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>最后，用客户端程序验证一下：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>

        <span class="n">Components</span> <span class="o">*</span><span class="n">phone</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ConcreteComponent</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">phone</span><span class="p">.</span><span class="n">callNumber</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">phone</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">);</span>
        <span class="n">ConcreteDecoratorA</span> <span class="o">*</span><span class="n">GPS</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ConcreteDecoratorA</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
        <span class="p">[</span><span class="n">GPS</span> <span class="nl">SetComponents</span><span class="p">:</span><span class="n">phone</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">GPS</span><span class="p">.</span><span class="n">callNumber</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">GPS</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">);</span>
        <span class="n">ConcreteDecoratorB</span> <span class="o">*</span><span class="n">bluetooth</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ConcreteDecoratorB</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
        <span class="p">[</span><span class="n">bluetooth</span> <span class="nl">SetComponents</span><span class="p">:</span><span class="n">phone</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">callNumber</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>执行结果：</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"> <span class="n">NokiaPhone</span> <span class="n">call</span> <span class="n">somebody</span>
 <span class="n">NokiaPhone</span> <span class="n">send</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">Somebody</span>
 <span class="n">NokiaPhone</span> <span class="n">call</span> <span class="n">somebody</span> <span class="n">with</span> <span class="n">GPS</span>
 <span class="n">NokiaPhone</span> <span class="n">send</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">Somebody</span> <span class="n">with</span> <span class="n">GPS</span>
 <span class="n">NokiaPhone</span> <span class="n">call</span> <span class="n">somebody</span> <span class="n">with</span> <span class="n">BlueTooth</span>
 <span class="n">NokiaPhone</span> <span class="n">send</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">Somebody</span> <span class="n">with</span> <span class="n">BlueTooth</span>
</code></pre></div></div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2013-01-10T00:00:00+08:00"><a href="http://morisunshine.com/life/travel-to-qinghai/">January 10, 2013</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/life/travel-to-qinghai/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/life/travel-to-qinghai/" rel="bookmark" title="站在原地, 心存远方" itemprop="url">站在原地, 心存远方</a></h1>
    
  </header>
  <div class="entry-description">旅行的意义是什么，在这次旅行之前，我好像很清楚，因为很多书中都可以找到，逃离原来的安全圈，发现自我，做自己想做的事情等等。可是，旅行之后，我却说不清楚，也许只是一次行走，从一个地方走到另一个地方，看看风景，与路上的人交朋友，互相交换故事，仅此而已。此刻我终于明白了《迟到的间隔年》中的一段话“旅行是寻找不到答案的，它只会让你多了选择，甚至更加迷茫，但完全值得”，当你在旅行中过于强调意义，注定得不到什么。所以冷暖自知，总有言语无法表达的心情，想要知道，就去旅行吧。</div>
  <div class="entry-content">
    <div class="full-text"><p><img src="/images/p7796217.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
旅行不是我一定要做的事，却是我一直想做的事。与旅行的结识，源于一部电影《第36个故事》，电影里的咖啡馆，浮想式的画面，以物易物，沙发客，环球旅行，都给那个漫长而又无聊的夏天带来了一阵清新的风。于是慢慢地开始去找寻许多关于旅行的故事，知道得愈多，对旅行的向往就愈强烈，然而看过了那么多关于旅行的书与电影，却发现自己依然站在原地。就像那些旅行的人常说的“只要踏出第一步，你就已经在路上了”，于是我一直在等待那第一步的到来。
</p>

<p style="text-indent: 2em;">
    2012年7月19号，我匆匆忙忙地结束了实习的最后工作，回到寝室整理背包，脸上是难以抑制的兴奋，因为再过十几个小时，我就可以开始我的远行。
</p>

<p style="text-indent: 2em;">
    每段旅行都是从交通工具开始，我坐上去兰州的火车，很幸运地买到了靠窗的位置，望着窗外，脑海中翻过很多旅行故事，想象着即将发生的一切。过不多久，火车开始运行，一直觉得绿皮火车是旅行的美好开始，车厢里的人充满人情味的对白，会让你忘了车途的颠簸。可是慢慢地开始困倦，望着窗外，渐渐倦意起来，眯了一会儿又醒来，急忙看着手机，才过了一个小时，于是从背包中抽出舒国治的《流浪集》来读，车厢内，摇摇晃晃，灯光，忽明忽暗，难以定神阅读，就这样迷迷糊糊，又昏昏欲睡，可是每睡一会并醒，醒的时候又看着窗外，风景依旧，知道自己只不过睡了一会儿，想象中那个有故事的人没来，对面坐着的大叔若无其事地磕着瓜子，没有发现我的期盼，我只能戴着耳机听着音乐，旅行还未开始，就已经感觉厌倦，只期望快点结束这漫长的颠簸。
</p>

<p style="text-indent: 2em;">
    接下来的十天，与同学们一起逛兰州的夜市，吃着各种没有吃过的美食，与一群同龄人包车环青海湖，途中有说有笑。远行之美，在于那在远方，距离让两个地方之间有许多不同，天空，白云，蓝天，草地，湖水，一切在南方可以看到的东西，在西部这个空旷的世界里，却见到更多，每一样风景都可以让我们心旷神怡，对于这些风景，言语总是匮乏，最好的表达就是坐在那里，静静远望，让感动留在心里。
 
</p>

<p><img src="/images/p7796228.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
印象中，独自旅行是最浪漫的方式，就像一个侠客，可以在天地之间任我飘逸。在兰州与同学们分开之后，我并开始了自己盼望已久的独自旅行，身边虽然没有可以了熟悉的朋友，却可以在路上遇到许多朋友，孤独也有孤独的自由。在通过同学的推荐下,我知道甘南这个地方,后来又在青旅里做过一些攻略，但是看来看去，最后还是只记住几个地名就上路了，太详细的攻略固定了旅行的不确定性，虽然保证了安全，却失去了很多乐趣。在来甘南之前，我在兰州的青旅里认识了在云南开酒吧的纪姐,还有一个在四川上大学的妹子,后来又在去夏河的大巴上认识了一个退伍军人，我们都叫他鞋子，还有两个女孩，我们就一起结伴。在夏河的最深印象就是出租车，无论到哪里都是一块钱，就像坐公交车一样方便。我们三天一直住在宝马宾馆，住宿费很便宜，只要15块钱一个晚上，白天我们一起去看了拉卜楞寺，桑科草原，八角古城，到了晚上就逛夏河，淘一些饰品带回去。我们到八角城的时候，就碰到一位夏河文化馆的馆长，原来他老家就在八角城，他那天是回家探亲，他很热情地为我们介绍这座有三千多年历史的八角古城，由于风化，原来的古城墙早已面目全非，只有站在高处，才能看到八角城的轮廓。馆长又把我们带到了一个小庙，那个小庙只有教室大小，然而里面却是整洁干净，在墙的周围种着娇艳的花朵，而地板上就像所有藏族区的寺庙一样被那些虔诚的藏民们跪得光滑，这时纪姐叫我们给这寺庙捐些钱，我就从兜里掏出五块钱想给守庙人，可是守庙人看到之后，拼命摇头，用藏语和馆长说了几句话，馆长对我们说“他说你们是远方来的客人，旅费本来就不多，你们还是自己用吧。”我当时听了之后，不知道该用什么语言去表达，相信这就是信仰下的善良，他们虽然物质匮乏内心却无比充实，而在那些物质丰富的大城市里，大部分人却活的并不快乐。后来我们又在街上闲逛，几个老人看见我们都很大方地向我们招手，我们对他们说“扎西得嘞”，他们也微笑地回应我们，在八角城的街头，总是能看到一个老人，手上拿着转经筒，端坐在地上，看着远处，我们静静走过，不忍心打扰。当我们准备离开的时候，一群孩子跑到村头向我们挥手，那一个个纯真的脸里上都是那个年龄该有的快乐。在回去的路上，我一直在想，是不是物质的匮乏反而让灵魂有地方栖息。
</p>

<p><img src="/images/p7796213.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
在夏河的第四天，我们的路线开始不同，我要回兰州坐火车回家了，他们还要继续旅行，于是和他们挥手再见。和他们分手之后，我还有一天的时间，打算去最近的合作市去看看，那天不是很急，就先去拉卜楞寺又转了一圈转经长廊，在转经筒的时候，心里不知道该默念什么，当时有了搭车去合作的想法，于是心里就开始默念成功搭到车，可是后来又想还是保佑自己快乐吧，后来又想是不是该保佑爸妈快乐，身体健康呢，又想还有朋友呢，于是贪心越来越大，就想佛祖不会保佑这么贪心的人的，还是保佑自己快乐吧，我快乐，关心我的人也会快乐，别人快乐所以我也会快乐，有因必有果。
</p>

<p><img src="/images/p7796219.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
搭车是我很意外的想法，本来这次旅行并没有搭车的准备，但是在青旅里遇到很多人都有过搭车的经历，听他们说起来自己的搭车经历觉得很简单，又很好玩，就想尝试一下，但是后来我跟同学说了这个想法之后，她说搭车不是那么容易的，会被拒绝很多次的。当时心里在犹豫，可是后来一想，拒绝就拒绝吧，又不会把我怎么样，旅行就是要尝试一下才有意思。就这样在旅行的最后一站，我举起了大拇指。我一边走一边问路人去合作的方向，一看到有车子经过就举起大拇指，可是大部分都是出租车停了下来，有些司机并没有理我，有些司机还是很和善地向我摇了摇手，我就一直向前方走，终于在一个路口，停下了一辆小面包车，坐在副驾驶座的大叔摇下窗户问我“你要去哪里？”我说：“我要去合作。”然后那个大叔就和驾驶座上的司机说了一下，就对我说“上来吧”。我很兴奋地坐上了后座，终于搭到第一辆车啦，可是没开多少里路，那个大叔转过头来对我说，一会儿给司机15块钱，我听了之后就懵了，后来就想给了钱就不叫搭车了，于是就叫司机在前面把我放下。又问了了路边的一个大叔这是不是去合作的方向，大叔点点头，我就又举起大拇指，刚举起大拇指，就又有一辆面包车停下来，打开车门叫我上来，由于刚才的经历，我对司机说的第一句话却是“要钱么？”司机大叔摇了摇头，我就上车了，心中羞愧自己的冒失，司机大叔好像在用藏语和家人聊天，我一句都听不懂，我想说谢谢，却不好意思打扰，当他一放下电话的时候，他就开口问我，“你是哪里人？”我说“我是浙江的”，于是就这样没有准备却很自然的聊了起来，慢慢地我的紧张感也慢慢放松下来，跟他说了自己最近的经历啊，司机大叔又跟我说了自己最近担忧的事，比如对这一代藏族孩子对信仰越来越不重视，还有到处修建的公路破坏了环境，他说开车有三十多年了，回忆起以前开车的日子，以前开车的时候虽然路况不好，窗外的风景却很美，即使开车的时候很颠簸，却依然很快乐。他后来又给我说了很多藏传佛教的知识，推荐了一些甘南比较美的地方，还教了我几句藏语，最后把我送到了合作的一个景点，九层佛阁，还告诉我在哪里可以坐到回兰州的大巴，我用他教我的藏语和他说“再见”。他和开心地和我挥手再见，开玩笑地说“回兰州可不能搭车咯”，我微笑地点点头。
</p>

<p><img src="/images/p7796225.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
旅行的意义是什么，在这次旅行之前，我好像很清楚，因为很多书中都可以找到，逃离原来的安全圈，发现自我，做自己想做的事情等等。可是，旅行之后，我却说不清楚，也许只是一次行走，从一个地方走到另一个地方，看看风景，与路上的人交朋友，互相交换故事，仅此而已。此刻我终于明白了《迟到的间隔年》中的一段话“旅行是寻找不到答案的，它只会让你多了选择，甚至更加迷茫，但完全值得”，当你在旅行中过于强调意义，注定得不到什么。所以冷暖自知，总有言语无法表达的心情，想要知道，就去旅行吧。
</p>

<p><img src="/images/p7796220.jpg" alt="图片"></p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->


<style type="text/css">body {background-image:url(/images/witewall_3.png);}</style>

<div class="pagination">
  
    
      <a href="http://morisunshine.com/page2" class="btn">Previous</a>
    
  
  <ul class="inline-list">
    <li>
      
        <a href="http://morisunshine.com">1</a>
      
    </li>
    
      <li>
        
          <a href="http://morisunshine.com/page2">2</a>
        
      </li>
    
      <li>
        
          <span class="current-page">3</span>
        
      </li>
    
  </ul>
  
    Next
  
</div><!-- /.pagination -->
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Sheldon. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://morisunshine.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://morisunshine.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-47868064-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script src="/assets/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

          


</body>
</html>