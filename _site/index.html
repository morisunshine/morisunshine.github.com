<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Just for fun &#8211; Morisunshine's Blog</title>
<meta name="description" content="Describe this nonsense.">


<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://morisunshine.com/images/header_bg.jpg">

<meta name="twitter:title" content="Just for fun">
<meta name="twitter:description" content="Describe this nonsense.">
<meta name="twitter:creator" content="@morisunshine">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Just for fun">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="http://morisunshine.com/index.html">
<meta property="og:site_name" content="Morisunshine's Blog">





<link rel="canonical" href="http://morisunshine.com/">
<link href="http://morisunshine.com/feed.xml" type="application/atom+xml" rel="alternate" title="Morisunshine's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://morisunshine.com/assets/css/main.min.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://morisunshine.com/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://morisunshine.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://morisunshine.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://morisunshine.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://morisunshine.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://morisunshine.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://morisunshine.com/images/apple-touch-icon-144x144-precomposed.png">



</head>

<link rel="stylesheet" href="/assets/css/solarized_dark.css">

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://morisunshine.com">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://morisunshine.com/images/avatar.png" alt="Sheldon photo" class="author-photo">
					<h4>Sheldon</h4>
					<p>1991-12-10</p>
				</li>
				<li><a href="http://morisunshine.com/about/">Know More</a></li>
				<li>
					<a href="mailto:sheldon.zen@gmail.com"><i class="icon-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/morisunshine"><i class="icon-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://weibo.com/u/1626743220"><i class="icon-weibo"></i> Weibo</a>
				</li>
				
				
				<li>
					<a href="http://linkedin.com/in/morisunshine"><i class="icon-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/morisunshine"><i class="icon-github"></i> GitHub</a>
				</li>
				<li>
					<a href="http://stackoverflow.com/users/2194236/morisunshine"><i class="icon-stackexchange"></i> Stackexchange</a>
				</li>
				<li>
					<a href="http://instagram.com/morisunshine"><i class="icon-instagram"></i> Instagram</a>
				</li>
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://morisunshine.com/posts/">All Posts</a></li>
				<li><a href="http://morisunshine.com/tags/">All Tags</a></li>
			</ul>
		</li>
		<li><a href="http://morisunshine.com/feed">Feed</a></li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://morisunshine.com/images/header_bg.jpg" alt="Just for fun">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Morisunshine's Blog</h1>
      <h2>Just for fun</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<style type="text/css">body {background-image:url(/images/witewall_3.png);}</style>

<div id="main" role="main">
  
<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-06-10T00:00:00+08:00"><a href="http://morisunshine.com/ios/replicating_uiscrollviews_deceleration_with_facebook/">June 10, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/replicating_uiscrollviews_deceleration_with_facebook/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/replicating_uiscrollviews_deceleration_with_facebook/" rel="bookmark" title="使用FaceceBook 的Pop框架替换UIScrollView的减速动画" itemprop="url">使用FaceceBook 的Pop框架替换UIScrollView的减速动画</a></h1>
    
  </header>
  <div class="entry-description">这个星期 Ole Begemann 写了一篇很棒的关于UIScrollView 是如何工作的教程，为了更有效地描述这个UIScrollView的工作机制，他甚至还自己从头开始写了一个简单的ScrollView。
这个过程其实非常简单， 用一个UIPanGestureRecognizer， 然后通过修改界面的bounds原点 来对滑动手势的平移做出响应。
我们很容易联想到可以在Ole的自定义ScrollView的基础上添加UIScrollview的惯性滑动行为，并且随着最近Facebook发布了POP动画引擎，让我觉得写出一个自然减速的自定义ScrollView会是一个很有趣的周末项目。</div>
  <div class="entry-content">
    <div class="full-text"><p>这个星期 Ole Begemann 写了一篇<a href="http://oleb.net/blog/2014/04/understanding-uiscrollview/">很棒的关于UIScrollView 是如何工作的教程</a>，为了更有效地描述这个UIScrollView的工作机制，他甚至还<a href="https://github.com/ole/CustomScrollView">自己从头开始写了一个简单的ScrollView。</a></p>

<p>这个过程其实非常简单， 用一个<code>UIPanGestureRecognizer</code>， 然后通过修改界面的bounds原点 来对滑动手势的平移做出响应。</p>

<p>我们很容易联想到可以在Ole的自定义ScrollView的基础上添加<code>UIScrollview</code>的惯性滑动行为，并且随着最近Facebook发布了POP动画引擎，让我觉得写出一个自然减速的自定义ScrollView会是一个很有趣的周末项目。</p>

<p>你可能不是很清楚，<a href="http://iosdevtips.co/post/84160910513/exploring-facebook-pop">POP 是Facebook最近开源的动画引擎框架</a>，它是Paper for iOS里所有动画背后的动画引擎。Pop的API看起来很像<code>CoreAnimation</code>，所以学起来并不难。</p>

<p>关于为什么使用Pop的两点最好的说明：</p>

<ol>
<li><p>它可以很容易地实现弹力和减速动画</p></li>
<li><p>使用Pop你就可以使任何<code>NSOject</code>子类中的任何property都实现动画，而不仅仅是那些在<code>UIKit</code>框架中被定义可以动画的那些类中的property。</p></li>
</ol>

<p>考虑到Pop能提供很好的减速动画，所以要在我们自定义的ScrollView中实现UIScrollView里的减速动画是不难的。</p>

<p>主要想法是在UIPanGestureRecognizer的结束状态时，通过减小ScrollView的速率来实现减速效果。</p>

<p>让我们开始吧。首先我们先在GitHub上Fork<a href="https://github.com/rounak/CustomScrollView">Ole的CustomScrollView项目</a>。跳到CustomScrollView.m中的<code>handlePanGesture:</code>方法。（为什么我们要重新fork项目，而不是直接用Ole 的项目？因为他在每次手势触发的时候，都将平移设置成为0，这样就会把速率重置为0，而速率正是我们的重要变量，所以我们需要保护它们。）</p>

<p>我们想要在手势已经结束的时候才开始减速动画，所以我们只关心switch语句中<code>UIGestureRecognizerStateEnded</code>的情况。</p>

<p>下面是代码的基本思路：</p>

<ul>
<li>我们通过<code>velocityInView:</code>方法得到手势的速率。</li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">CGPoint velocity = [panGestureRecognizer velocityInView:self];
</code></pre></div>
<ul>
<li>如果在水平方向或垂直方向没有足够空间那么我就不希望在x或y方向上能移动。所以我们要添加一个判断。</li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">if (self.bounds.size.width &gt;= self.contentSize.width) {
        velocity.x = 0;
}
if (self.bounds.size.height &gt;= self.contentSize.height) {
        velocity.y = 0;
}
</code></pre></div>
<ul>
<li><p>我们发现通过<code>velocityInView:</code>方法得到的速率实际上并不是我们想要的，所以我们要修复这个问题。</p></li>
<li><p>我们想要使界面的bounds（尤其是bound中的原点）动画，所以我们就创建了一个新的带kPOPViewBounds的POPDecayAnimation对象。</p></li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">POPDecayAnimation *decayAnimation = [POPDecayAnimation animationWithPropertyNamed:kPOPViewBounds]
</code></pre></div>
<ul>
<li><p>Pop希望速率和你希望动画的property在相同的坐标系下。这个值可能是指向透明度的NSNumber（CGFloat），被封装在NSValue的CGPoint来指向界面的中心，被封装在NSValue的CGRect来指向bounds，等等。你可能已经猜到了，在动画过程中，property值的变化就相当于是速率。</p></li>
<li><p>在我们这个项目中，我们要使bounds动画，这就意味我们的速率会是CGRect的变化引起的，并且它的原点的x和y值的变化相当于是bounds的原点上的变化。类似的，尺寸中的宽和高的速率就相当于bounds的尺寸变化。</p></li>
<li><p>我们不想改变bounds中的尺寸，所以就让尺寸的速率一直保持0。将原点的x和y值的速率作为滑动手势的速率输入。把这些值封装到一个NSValue中并将它赋值给decayAnimation.velocity。</p></li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">decayAnimation.velocity = [NSValue valueWithCGRect:CGRectMake(velocity.x, velocity.y, 0, 0)];
</code></pre></div>
<ul>
<li>最后，通过使用<code>pop_addAnimation:</code>方法将decayAnimation添加到界面中，并且给界面添加任意想要的键值。</li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">[self pop_addAnimation:decayAnimation forKey:@&quot;decelerate&quot;];
</code></pre></div>
<p>这里是组合的代码：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">
//从滑动手势中得到速率
if (self.bounds.size.width &gt;= self.contentSize.width) {
        //当水平方向没有空间滑动就把平移为0
        velocity.x = 0; 
}
if (self.bounds.size.height &gt;= self.contentSize.height) {
        //当垂直方向没有空间滑动就把平移为0
        velocity.y = 0; 
}

//我们需要将从滑动手势中得到的速率转换成负号，所以我们改变了一下符号。
velocity.x = -velocity.x;
velocity.y = -velocity.y;

POPDecayAnimation *decayAnimation = [POPDecayAnimation animationWithPropertyNamed:kPOPViewBounds];

//最后两个零代表我们不想变化bound的尺寸
decayAnimation.velocity = [NSValue valueWithCGRect:CGRectMake(velocity.x, velocity.y, 0, 0)];

[self pop_addAnimation:decayAnimation forKey:@&quot;decelerate&quot;];
</code></pre></div>
<p><img src="http://media.tumblr.com/185a108dfa8a706c90985b18198bd39c/tumblr_inline_n4z4hwnQiv1qh9cw7.gif" alt="image"></p>

<p>通过上面的代码，我们已经实现了基本的减速动画。你可能会注意到，当你的速率很高的时候，这个界面会滑到超过他的<code>contentSize</code>，没关系，这个很容易解决，只要我们重写<code>setBounds:</code>方法并且添加判断这个bounds是否将要超过它contentSize就行了。但让我惊讶的是，Pop自己没有添加这些判断。</p>

<hr>

<p>有意思的是POP能够让所有的property都能实现动画效果，而不仅仅是那些被UIKit定义可以实现动画的property。因为我们只是让bounds的原点动画了，所以我们可以实验一下POP是否真的能让所有的property都能动画。</p>

<p>POP能够这样做是因为它为我们提供了动画进度的常量回调函数，这样我们就能即使更新我们的界面。它实现了最难的部分--处理定时，将这些定时转换成你的property的值，减速或者震荡等等。</p>

<p>所以接下来就是做和最开始同样的事，但不同的是现在用自己自定义的property。这里我们想要bounds的原点的x和y动画。代码的结构大部分是差不多的，除了POPAnimatableProperty的初始化。</p>

<ul>
<li><p>property名字，个人理解，它可以是任意字符串。在这个项目中，我命名它为@&quot;com.rounak.bounds.origin&quot;</p></li>
<li><p>这里也有一个使用POPMutableAnimatableProperty作为参数的初始化block。（我觉得这个初始化模式应该被命名为生成器模式）</p></li>
<li><p>POPMutableAnimatableProperty有两个重要的property，readBlock 和 writeBlock。在readBlock中，你需要输入数据给POP，而在writeBlock中，你需要收回这些数据，然后更新你的界面。readBlcok只会被调用一次，而writeBlock会在每次更新显示（比如CADisplayLink）的帧时就会被调用。</p></li>
<li><p>POP内部会将所有东西都转换成向量，因此他给我们提供的数据都是以由CGFloat组成的线性数组。</p></li>
<li><p>在readBlock中我们简单地将bounds的原点x和y分别赋值给values[0]和values[1]。</p></li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">prop.readBlock = ^(id obj, CGFloat values[]) {
        values[0] = [obj bounds].origin.x;
                values[1] = [obj bounds].origin.y;
};
</code></pre></div>
<ul>
<li>然后在 writeBlock 中，你读取values<a href="bounds.origin.x">0</a> 和 values<a href="bounds.origin.y">1</a>，并且更新你界面中的bounds</li>
</ul>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">prop.writeBlock = ^(id obj, const CGFloat values[]) {
    CGRect tempBounds = [obj bounds];
    tempBounds.origin.x = values[0];
    tempBounds.origin.y = values[1];
    [obj setBounds:tempBounds];
};
</code></pre></div>
<ul>
<li><p>当writeBlock中的值随着减速（或震荡）曲线被每次调用时，神奇的事情发生了。</p></li>
<li><p>你会注意到当我们两个方向去操作时，我们的速率是CGPoint而不是CGRect。</p></li>
</ul>

<p>下面是组合的代码：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">
//从滑动手势中得到速率
CGPoint velocity = [panGestureRecognizer velocityInView:self];
if (self.bounds.size.width &gt;= self.contentSize.width) {
    //当没有水平方向滑动时就让x方向的移动为0
    velocity.x = 0;
}
if (self.bounds.size.height &gt;= self.contentSize.height) {
    //当没有垂直方向滑动时就让y方向的移动为0
    velocity.y = 0;
}

//我的需要从滑动手势中的到速率的负数，所以我们加上了符号。
velocity.x = -velocity.x;
velocity.y = -velocity.y;

POPDecayAnimation *decayAnimation = [POPDecayAnimation animation];

POPAnimatableProperty *prop = [POPAnimatableProperty propertyWithName:@&quot;com.rounak.boundsY&quot; initializer:^(POPMutableAnimatableProperty *prop) {
    // 读取数据，输入数据给POP
    prop.readBlock = ^(id obj, CGFloat values[]) {
        values[0] = [obj bounds].origin.x;
        values[1] = [obj bounds].origin.y;
    };
    // 写数据，从POP中得到数据，并且将它应用到视图上。
    prop.writeBlock = ^(id obj, const CGFloat values[]) {
        CGRect tempBounds = [obj bounds];
        tempBounds.origin.x = values[0];
        tempBounds.origin.y = values[1];
        [obj setBounds:tempBounds];
    };
    //动态临界值
    prop.threshold = 0.01;
}];

decayAnimation.property = prop;
decayAnimation.velocity = [NSValue valueWithCGPoint:velocity];
[self pop_addAnimation:decayAnimation forKey:@&quot;decelerate&quot;];

</code></pre></div>
<p>实现减速效果的完整项目<a href="https://github.com/rounak/CustomScrollView/tree/custom-scroll-with-pop">可以在GitHub中找到</a>。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-06-02T00:00:00+08:00"><a href="http://morisunshine.com/reading/the_art_of_readable_code/">June 02, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/reading/the_art_of_readable_code/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/reading/the_art_of_readable_code/" rel="bookmark" title="《编写可读代码的艺术》读书笔记" itemprop="url">《编写可读代码的艺术》读书笔记</a></h1>
    
  </header>
  <div class="entry-description">代码应当写的容易理解，这就是为什么要读这本书的原因。代码也是美的，就像文章一样，好的文章能让我们获得很多理念或者想法，并且在阅读的过程中也是那么地愉快与自然。而在编程中，我们大部分时间做的事情并不是在写代码，而是在测试、修改还有阅读，如果连我们自己都不能去更好地理解我们自己写的代码时，那我们又怎么能别人去理解呢，到时他心里一定在臭骂你，虽然你已经与这个项目没有关系，但是如果你想成为一个优秀的程序员，我想你一定不会希望在别人心里是这样的人，当别人用你的产品时，别人看不到背后的代码，但这不意味可以随意写，看不到的事情才是最可怕的，如果我们未来想做一些改动，那么你要做的可能就是重构了，而我们现在大部分意义上的重构，最后也只是变成把以前的代码再重写。</div>
  <div class="entry-content">
    <div class="full-text"><blockquote>
<p>代码应当写的容易理解</p>
</blockquote>

<p>这就是为什么要读这本书的原因。代码也是美的，就像文章一样，好的文章能让我们获得很多理念或者想法，并且在阅读的过程中也是那么地愉快与自然。而在编程中，我们大部分时间做的事情并不是在写代码，而是在测试、修改还有阅读，如果连我们自己都不能去更好地理解我们自己写的代码时，那我们又怎么能别人去理解呢，到时他心里一定在臭骂你，虽然你已经与这个项目没有关系，但是如果你想成为一个优秀的程序员，我想你一定不会希望在别人心里是这样的人，当别人用你的产品时，别人看不到背后的代码，但这不意味可以随意写，看不到的事情才是最可怕的，如果我们未来想做一些改动，那么你要做的可能就是重构了，而我们现在大部分意义上的重构，最后也只是变成把以前的代码再重写。    </p>

<p>我很确定，我还会再读这本书，因为让代码变得可读，并不是你看一遍书，你就能实现的，它需要我们的练习与实践，并且作者也提供了一个很好的方式来检验我们的代码的可读性，找一个朋友去读你这段代码，看他能否理解你这段代码的真实目的。更何况，要将代码写成艺术，这更是需要时间。</p>

<blockquote>
<p>把理解代码所需的时间最小化是一个更好的目标</p>
</blockquote>

<h1>表面层次的改进</h1>

<h2>把信息塞入名字</h2>

<p>这句话的意思就是让阅读者（可能是你也可能是其他人）通过名字就可以获得大量的信息</p>

<ul>
<li>使用专业的单词</li>
<li>避免空泛的名字</li>
<li>使用具体的名字来细致地描述事物</li>
<li>给变量名带上重要的细节</li>
<li>为作用域大的名字采用更长的名字</li>
<li>有目的地使用大小写、下划线等</li>
</ul>

<h2>审美</h2>

<p>这有点像书或者杂志总的排版，让内容更适合阅读。</p>

<ul>
<li>使用一致的布局，让读者习惯你的代码风格</li>
<li>让相似的代码看上去相似，比如类似功能的代码就可以同样的格式，这样就容易让人联想这个功能与那个功能应该是类似的。</li>
<li>把相关的代码行分组，形成代码块。</li>
<li>一致的风格比“正确”的风格更重要</li>
</ul>

<h2>注释</h2>

<p>注释的目的是尽量帮助读者了解得和作者一样多。</p>

<ul>
<li>不要为那些从代码本身就能快速推断的事实写注释</li>
<li>如果你不能一句话写清楚，那就多提供更多细节</li>
<li>不要给不好的名字加注释，而是应该把名字改好。这个我之前没有意识到这点。所以还是好名字比一个好注释更重要。</li>
<li>记录你的思想，比如就像git中的commit，可以写一些这段代码做的事情，你遇到的坑，这样也能你的思想过程记录下来，对后面的维护也有依据。但是别写的太多。</li>
<li>尽量精确地描述函数的行为。</li>
</ul>

<h1>简化循环和逻辑</h1>

<blockquote>
<p>每当你看到一个复杂的逻辑，一个巨大的表达式或者一大推变量，这些都会增加你头脑中的思维包袱。它需要让你考虑得更复杂并且记住更多事情。</p>
</blockquote>

<h2>拆分超长的表达式</h2>

<ul>
<li>代码中的表达式越长，它就越难以理解。</li>
<li>可以增加一个总结变量来代表一段表达式。</li>
<li>很多表达式都是一样，那就将它提取出来，作为一个方法---Don&#39;t repeat yourself</li>
</ul>

<h2>变量与可读性</h2>

<ul>
<li>变量越多，就越难跟踪它们的动向。</li>
<li>变量的作用域越大，就需要跟踪它的动向越久。</li>
<li>变量改变得越频繁，就越难以跟踪它的当前值。</li>
</ul>

<h1>重新组织代码</h1>

<h2>抽取不相关的子问题</h2>

<ul>
<li>通用代码很好，因为“它完全从项目的其他部分中解耦出”。像这样的代码容易开发，容易测试，并且容易理解。</li>
<li>你永远不要安于使用不理想的接口。你总是可以创建你自己的包装函数来隐藏接口的重要细节，让它不再成为你的阻碍。</li>
<li>应该把代码组织得一次做一件事。</li>
<li>最可读的代码就是没有代码。</li>
<li>通过重用库或者减少功能，你可以节省时间并且让你的代码库保持精简节约。</li>
</ul>

<h1>测试与可读性</h1>

<ul>
<li>测试应当具有可读性，以便其他程序员可以舒服地改变或者增加测试。</li>
<li>对使用者隐去不重要的细节，以便更重要的细节会更突出。</li>
<li>代码时想着测试这件事就能帮助把代码写得更好。</li>
<li>解耦合最好的那一个往往就是最容易测试的那个。</li>
</ul>

<h1>笔记总结</h1>

<p>如何将编写代码当做艺术看待，这与我们的追求有关，但是艺术是什么呢，其实就是每天的积累与进步，当我们每天花一些时间去思考这样的命名适不适合，这样的结构合不合理，也许我们也能成为自己代码的艺术家，这真的很像《黑客与画家》中说的手工艺人，“如切如磋 如琢如磨”，正是如此。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-05-17T00:00:00+08:00"><a href="http://morisunshine.com/ios/interactive_animations/">May 17, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/interactive_animations/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/interactive_animations/" rel="bookmark" title="交互式动画" itemprop="url">交互式动画</a></h1>
    
  </header>
  <div class="entry-description">随着 iOS7 中从对拟物化的视觉效果的远离，以及对 UI 行为的关注，真实的交互式动画通向未来的大道变得越来越明显。它们也是将初代 iPhone 中滑动行为的魔力延续到交互的各个方面的一条康庄大道。为了让这些魔力成为现实，我们就不能在开发过程中才想到这些动画，而是应该在设计时就要考虑这些交互，这一点非常重要。</div>
  <div class="entry-content">
    <div class="full-text"><p><a href="http://www.objc.io/issue-12/interactive-animations.html">原文</a>作者<a href="https://twitter.com/chriseidhof">Chris Eidhof</a>和<a href="https://twitter.com/floriankugler">Florian Kugler</a>。转载请注明出处！</p>

<p>在2007年，乔布斯在第一次介绍 iPhone 的时候，iPhone 的触摸屏交互简直就像是一种魔法。最好的例子就是在他<a href="https://www.youtube.com/watch?v=t4OEsI0Sc_s&amp;t=16m9s">第一次滑动 TableView 的展示上</a>。你可以感受到当时观众的反应是多么惊讶，但是对于现在的我们来说早已习以为常。在展示的后面一部分，他特别指出当他给别人看了这个滑动例子，别人说的一句话: <a href="https://www.youtube.com/watch?v=t4OEsI0Sc_s&amp;t=16m9s">“当这个界面滑动的时候我就已经被征服了”</a>.</p>

<p>是什么样的滑动能让人有‘哇哦’的效果呢？</p>

<p>滑动是最完美地展示了通过触摸屏直接操作的例子。滚动视图遵从于你的手指，当你的手指离开屏幕的时，视图会自然地继续滑动直到该停止的时候停止。它用自然的方式减速，甚至在快到界限的时候也能表现出细腻的弹力效果。滑动在任何时候都保持相应，并且看上去非常真实。</p>

<h2>动画的状态</h2>

<p>在 iOS 中的大部分动画仍然没有按照最初 iPhone 指定的滑动标准实现。这里有很多动画一旦它们运行就不能交互（比如说解锁动画，主界面中打开文件夹和关闭文件夹的动画，和导航栏切换的动画，还有很多）。</p>

<p>然而现在有一些应用给我一种始终在控制动画的体验，我们可以直接操作那些我在用的动画。当我们将这些应用和其他的应用相比较之后，我们就能感觉到明显的区别。这些应用中最优秀的有最初的 Twitter iPad app， 和现在的 Facebook Paper。但目前，使用直接操作为主并且可以中断动画的应用仍然很少。这就给我们做出更好的应用提供了机会，让我们的应用有更不同的，更高质量的体验。</p>

<h2>真实交互式动画的挑战</h2>

<p>当我们用 UIView 或者 CAAnimation 来实现交互式动画时会有两个大问题: 这些动画会将你在屏幕上的内容和 layer 上的实际的特定属性分离开来，并且他们直接操作这些特定属性。</p>

<h3>模型 (Model) 和显示 (Presentation) 的分离</h3>

<p>Core Animation 是通过分离 layer 的模型属性和你在屏幕上看到的界面 (显示层) 的方式来设计的，这就导致我们很难去创建一个可以在任何时候能交互的动画，因为在动画时，模型和界面已经不能匹配了。这时，我们不得不通过手动的方式来同步这两个的状态，来达到改变动画的效果：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">view.layer.center = view.layer.presentationLayer.center;
[view.layer removeAnimationForKey:@&quot;animation&quot;];
// 添加新动画
</code></pre></div>
<h3>直接控制 vs 间接控制</h3>

<p><code>CAAnimation</code> 动画的更大的问题是它们是直接在 layer 上对属性进行操作的。这意味着什么呢？比如我们想指定一个 layer 从坐标为 (100, 100) 的位置运动到 (300, 300) 的位置，但是在它运动到中间的时候，我们想它停下来并且让它回到它原来的位置，事情就变得非常复杂了。如果你只是简单地删除当前的动画然后再添加一个新的，那么这个 layer 的速率就会不连续。</p>

<p><img src="http://img.objccn.io/issue-12/abrupt.png" width="600" /></p>

<p>然而，我们想要的是一个漂亮的，流畅地减速和加速的动画。</p>

<p><img src="http://img.objccn.io/issue-12/smooth.png" width="600" /></p>

<p>只有通过<em>间接</em>操作动画才能达到上面的效果，比如通过模拟力在界面上的表现。新的动画需要用 layer 的当前<em>速度矢量</em>作为参数传入来达到流畅的效果。</p>

<p>看一下 UIView 中关于弹簧动画的 API <code>animateWithDuration:delay:usingSpringWithDamping:initialSpringVelocity:options:animations:completion:</code>
，你会注意到速率是个 <code>CGFloat</code>。所以当我们给一个移动 view 的动画在其运动的方向上加一个初始的速率时，你没法告知动画这个 view 现在的运动状态，比如我们不知道要添加的动画的方向是不是和原来的 view 的速度方向垂直。为了使其成为可能，这个速度需要用向量来表示。</p>

<h2>解决方案</h2>

<p>让我们看一下我们怎样来正确实现一个可交互并且可以中断的动画。我们来做一个类似于控制中心板的东西来实现这个效果：</p>

<p><video controls="1" style="display:block;max-width:100%;height:auto;border:0;">
  <source src="http://www.objc.io/images/issue-12/interactive-animation.mov">
</video></p>

<p>这个控制板有两个状态：打开和关闭。你可以通过点击来切换这两个状态，或者通过上下拖动来调调整它向上或向下。我要将这个控制面板的所有状态都做到可以交互，甚至是在动画的过程中也可以，这是一个很大的挑战。比如，当你在这个控制板还没有切换到打开状态的动画过程中，你点击了它，那么它应该从现在这个点的位置马上回到关闭状态的位置。在现在很多的应用中，大部分都是用默认的动画 API，你必须要等一个动画结束之后你才能做自己想做的事情。或者，如果你不等待的话，就会看到一个不连续的速度曲线。我们要解决这个问题。</p>

<h3>UIKit 力学</h3>

<p>随着 iOS7 的发布，苹果向我们展示了一个叫 UIKit 力学的动画框架 (可以参见 WWDC 2013 sessions <a href="https://developer.apple.com/videos/wwdc/2013/index.php?id=206">206</a> 和 <a href="https://developer.apple.com/videos/wwdc/2013/index.php?id=221">221</a>)。UIKit 力学是一个基于模拟物理引擎的框架，只要你添加指定的行为到动画对象上来实现 <a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIDynamicItem_Protocol/Reference/Reference.html">UIDynamicItem</a> 协议就能实现很多动画。这个框架非常强大，并且它能够在多个物体间启用像是附着和碰撞这样的复杂行为。请看一下 <a href="https://developer.apple.com/library/ios/samplecode/DynamicsCatalog/Introduction/Intro.html">UIKit Dynamics Catalog</a>，确认一下什么是可用的。</p>

<p>因为 UIKit 力学中的的动画是被间接驱动的，就像我在上面提到的，这使我们实现真实的交互式动画成为可能，它能在任何时候被中断并且拥有连续的加速度。同时，UIKit 力学在物理层的抽象上能完全胜任我们一般情况下在用户界面中的所需要的所有动画。其实在大部分情况下，我们只会用到其中的一小部分功能。</p>

<h4>定义行为</h4>

<p>为了实现我们的控制板的行为，我们将使用 UIkit 力学中的两个不同行为：<a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIAttachmentBehavior_Class/Reference/Reference.html">UIAttachmentBehavior</a> 和 <a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIDynamicItemBehavior_Class/Reference/Reference.html">UIDynamicItemBehavior</a>。附着行为用来扮演弹簧的角色，它将界面向目标点拉动。另一方面，我们用动态 item behvaior 定义了比如摩擦系数这样的界面的内置属性。</p>

<p>我创建了一个我们自己的行为子类，以将这两个行为封装到我们的控制板上:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">@interface PaneBehavior : UIDynamicBehavior

@property (nonatomic) CGPoint targetPoint;
@property (nonatomic) CGPoint velocity;

- (instancetype)initWithItem:(id &lt;UIDynamicItem&gt;)item;

@end
</code></pre></div>
<p>我们通过一个 dynamic item 来初始化这个行为，然后就可以设置它的目标点和我们想要的任何速度。在内部，我们创建了附着行为和 dynamic item 行为，并且将这些行为添加到我们自定义的行为中:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)setup
{
    UIAttachmentBehavior *attachmentBehavior = [[UIAttachmentBehavior alloc] initWithItem:self.item attachedToAnchor:CGPointZero];
    attachmentBehavior.frequency = 3.5;
    attachmentBehavior.damping = .4;
    attachmentBehavior.length = 0;
    [self addChildBehavior:attachmentBehavior];
    self.attachmentBehavior = attachmentBehavior;

    UIDynamicItemBehavior *itemBehavior = [[UIDynamicItemBehavior alloc] initWithItems:@[self.item]];
    itemBehavior.density = 100;
    itemBehavior.resistance = 10;
    [self addChildBehavior:itemBehavior];
    self.itemBehavior = itemBehavior;
}
</code></pre></div>
<p>为了用 <code>targetPoint</code> 和 <code>velocity</code> 属性来影响 item 的 behavior，我们需要重写它们的 setter 方法，并且分别修改在附着行为和 item behaviors 中的对应的属性。我们对目标点的 setter 方法来说，这个改动很简单：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)setTargetPoint:(CGPoint)targetPoint
{
    _targetPoint = targetPoint;
    self.attachmentBehavior.anchorPoint = targetPoint;
}
</code></pre></div>
<p>对于 <code>velocity</code> 属性，我们需要多做一些工作，因为 dynamic item behavior 只允许相对地改变速度。这就意味如果我们要将 <code>velocity</code> 设置为绝对值，首先我们就需要得到当前的速度，然后再加上速度差才能得到我们的目标速度。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)setVelocity:(CGPoint)velocity
{
    _velocity = velocity;
    CGPoint currentVelocity = [self.itemBehavior linearVelocityForItem:self.item];
    CGPoint velocityDelta = CGPointMake(velocity.x - currentVelocity.x, velocity.y - currentVelocity.y);
    [self.itemBehavior addLinearVelocity:velocityDelta forItem:self.item];
}
</code></pre></div>
<h3>将Behavior投入使用</h3>

<p>我们的控制板有三个不同状态：在开始或结束位置的静止状态，正在被用户拖动的状态，以及在没有用户控制时运动到结束位置的动画状态。</p>

<p>为了将从直接操作状态 (用户拖动这个滑动板) 过渡到动画状态这个过程做的流畅，我们还有很多其他的事要做。当用户停止拖动控制板时，它会发送一个消息到它的 delegate。根据这个方法，我们可以知道这个板应该朝哪个方向运动，然后在我们自定义的 <code>PaneBehavior</code> 上设置结束点，以及初始速度 (这非常重要)，并将行为添加到动画器中去，以此确保从拖动操作到动画状态这个过程能够非常流畅。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)draggableView:(DraggableView *)view draggingEndedWithVelocity:(CGPoint)velocity
{
    PaneState targetState = velocity.y &gt;= 0 ? PaneStateClosed : PaneStateOpen;
    [self animatePaneToState:targetState initialVelocity:velocity];
}

- (void)animatePaneToState:(PaneState)targetState initialVelocity:(CGPoint)velocity
{
    if (!self.paneBehavior) {
        PaneBehavior *behavior = [[PaneBehavior alloc] initWithItem:self.pane];
        self.paneBehavior = behavior;
    }
    self.paneBehavior.targetPoint = [self targetPointForState:targetState];
    if (!CGPointEqualToPoint(velocity, CGPointZero)) {
        self.paneBehavior.velocity = velocity;
    }
    [self.animator addBehavior:self.paneBehavior];
    self.paneState = targetState;
}
</code></pre></div>
<p>一旦用户用他的手指再次触动控制板时，我必须要将所有的 dynamic behavior 从 animator 删除，这样才不会影响控制板对拖动手势的响应：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)draggableViewBeganDragging:(DraggableView *)view
{
    [self.animator removeAllBehaviors];
}
</code></pre></div>
<p>我们不仅仅允许控制板可以被拖动，还要允许它可以被点击，让它可以从一个位置跳转到另一个位置以达到开关的效果。一旦点击事件发生，我们就会立即调整这个滑动板的目标位置。因为我们不能直接控制动画，但是通过弹力和摩擦力，我们的动画可以非常流畅地执行这个动作：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)didTap:(UITapGestureRecognizer *)tapRecognizer
{
    PaneState targetState = self.paneState == PaneStateOpen ? PaneStateClosed : PaneStateOpen;
    [self animatePaneToState:targetState initialVelocity:CGPointZero];
}
</code></pre></div>
<p>这样就实现了我们的大部分功能了。你可以在 <a href="https://github.com/objcio/issue-12-interactive-animations-uidynamics">GitHub</a> 上查看完整的例子。</p>

<p>重申一点：UIKit 力学可以通过在界面上模拟力来间接地驱动动画（我们的例子中，使用的是弹力和摩擦力）。这间接地使我们在任何时候都能以连续的速度曲线来与界面进行交互。</p>

<p>现在我们已经通过 UIKit 力学实现了整个交互，让我们回顾一下这个场景。这个例子的动画中我们只用了 UIKit 力学中一小部分功能，并且它的实现方式也非常简单。对于我们来说这是一个去理解它其中的过程的很好的例子，但是如果我们使用的环境中没有 UIKit  力学 (比如说在 Mac 上)，或者你的使用场景中不能很好的适用 UIKit 力学呢。</p>

<h2>自己操作动画</h2>

<p>至于在你的应用中大部分时间会用的动画，比如简单的弹力动画，我们控制它真的不难。我们可以做一个练习，来看看如何抛弃 UIKit 力学这个巨大的黑盒子，看要如何“手动”来实现一个简单的交互。想法非常简单：我们只要每秒修改这个 view 的 frame 60 次。每一帧我们都基于当前速度和作用在 view 上的力来调整 view 的 frame 就可以了。</p>

<h3>物理原理</h3>

<p>首先让我们看一下我们需要知道的基础物理知识，这样我们才能实现出刚才使用 UIKit 力学实现的那种弹簧动画效果。为了简化问题，虽然引入第二个维度也是很直接的，但我们在这里只关注一维的情况 (在我们的例子中就是这样的情况)。</p>

<p>我们的目标是依据控制面板当前的位置和上一次动画后到现在为止经过的时间，来计算它的新位置。我们可以把它表示成这样：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">y = y0 + Δy
</code></pre></div>
<p>位置的偏移量可以通过速度和时间的函数来表达：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Δy = v ⋅ Δt
</code></pre></div>
<p>这个速度可以通过前一次的速度加上速度偏移量算出来，这个速度偏移量是由力在 view 上的作用引起的。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">v = v0 + Δv
</code></pre></div>
<p>速度的变化可以通过作用在这个 view 上的冲量计算出来：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Δv = (F ⋅ Δt) / m
</code></pre></div>
<p>现在，让我们看一下作用在这个界面上的力。为了得到弹簧效果，我们必须要将摩擦力和弹力结合起来：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">F = F_spring + F_friction
</code></pre></div>
<p>弹力的计算方法我们可以从任何一本教科书中得到 (编者注：简单的胡克定律)：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">F_spring = k ⋅ x
</code></pre></div>
<p><code>k</code> 是弹簧的劲度系数，<code>x</code> 是 view 到目标结束位置的距离 (也就是弹簧的长度)。因此，我们可以把它写成这样：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">F_spring = k ⋅ abs(y_target - y0)
</code></pre></div>
<p>摩擦力和 view 的速度成正比：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">F_friction = μ ⋅ v
</code></pre></div>
<p><code>μ</code> 是一个简单的摩擦系数。你可以通过别的方式来计算摩擦力，但是这个方法能很好地做出我们想要的动画效果。</p>

<p>将上面的表达式放在一起，我们就可以算出作用在界面上的力：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">F = k ⋅ abs(y_target - y0) + μ ⋅ v
</code></pre></div>
<p>为了实现起来更简单点些，我们将 view 的质量设为 1，这样我们就能计算在位置上的变化：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Δy = (v0 + (k ⋅ abs(y_target - y0) + μ ⋅ v) ⋅ Δt) ⋅ Δt
</code></pre></div>
<h3>实现动画</h3>

<p>为了实现这个动画，我们首先需要创建我们自己的 <code>Animator</code> 类，它将扮演驱动动画的角色。这个类使用了 <code>CADisplayLink</code>，<code>CADisplayLink</code> 是专门用来将绘图与屏幕刷新频率相同步的定时器。换句话说，如果你的动画是流畅的，这个定时器就会每秒调用你的方法60次。接下来，我们需要实现 <code>Animation</code> 协议来和我们的 <code>Animator</code> 一起工作。这个协议只有一个方法，<code>animationTick:finished:</code>。屏幕每次被刷新时都会调用这个方法，并且在方法中会得到两个参数：第一个参数是前一个 frame 的持续时间，第二个参数是一个指向 <code>BOOL</code> 的指针。当我们设置这个指针的值为 <code>YES</code> 时，我们就可以与 <code>Animator</code> 取得通讯并汇报动画完成；</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">@protocol Animation &lt;NSObject&gt;
- (void)animationTick:(CFTimeInterval)dt finished:(BOOL *)finished;
@end
</code></pre></div>
<p>我们会在下面实现这个方法。首先，根据时间间隔我们来计算由弹力和摩擦力的合力。然后根据这个力来更新速度，并调整 view 的中心位置。最后，当这个速度降低并且 view 到达结束位置时，我们就停止这个动画：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)animationTick:(CFTimeInterval)dt finished:(BOOL *)finished
{
    static const float frictionConstant = 20;
    static const float springConstant = 300;
    CGFloat time = (CGFloat) dt;

    //摩擦力 = 速度 * 摩擦系数
    CGPoint frictionForce = CGPointMultiply(self.velocity, frictionConstant);
    //弹力 = (目标位置 - 当前位置) * 弹簧劲度系数
    CGPoint springForce = CGPointMultiply(CGPointSubtract(self.targetPoint, self.view.center), springConstant);
    //力 = 弹力 - 摩擦力
    CGPoint force = CGPointSubtract(springForce, frictionForce);

    //速度 = 当前速度 + 力 * 时间 / 质量
    self.velocity = CGPointAdd(self.velocity, CGPointMultiply(force, time));
    //位置 = 当前位置 + 速度 * 时间
    self.view.center = CGPointAdd(self.view.center, CGPointMultiply(self.velocity, time));

    CGFloat speed = CGPointLength(self.velocity);
    CGFloat distanceToGoal = CGPointLength(CGPointSubtract(self.targetPoint, self.view.center));
    if (speed &lt; 0.05 &amp;&amp; distanceToGoal &lt; 1) {
        self.view.center = self.targetPoint;
        *finished = YES;
    }
}
</code></pre></div>
<p>这就是这个方法里的全部内容。我们把这个方法封装到一个 <code>SpringAnimation</code> 对象中。除了这个方法之外，这个对象中还有一个初始化方法，它指定了 view 中心的目标位置 (在我们的例子中，就是打开状态时界面的中心位置，或者关闭状态时界面的中心位置) 和初始的速度。</p>

<h3>将动画添加到 view 上</h3>

<p>我们的 view 类刚好和使用 UIDynamic 的例子一样：它有一个拖动手势，并且根据拖动手势来更新中心位置。它也有两个同样的 delegate 方法，这两个方法会实现动画的初始化。首先，一旦用户开始拖动控制板时，我们就取消所有动画：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)draggableViewBeganDragging:(DraggableView *)view
{
    [self cancelSpringAnimation];
}
</code></pre></div>
<p>一旦停止拖动，我们就根据从拖动手势中得到的最后一个速率值来开始我们的动画。我们根据拖动状态 <code>paneState</code> 计算出动画的结束位置：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)draggableView:(DraggableView *)view draggingEndedWithVelocity:(CGPoint)velocity
{
    PaneState targetState = velocity.y &gt;= 0 ? PaneStateClosed : PaneStateOpen;
    self.paneState = targetState;
    [self startAnimatingView:view initialVelocity:velocity];
}

- (void)startAnimatingView:(DraggableView *)view initialVelocity:(CGPoint)velocity
{
    [self cancelSpringAnimation];
    self.springAnimation = [UINTSpringAnimation animationWithView:view target:self.targetPoint velocity:velocity];
    [view.animator addAnimation:self.springAnimation];
}
</code></pre></div>
<p>剩下来要做的就是添加点击动画了，这很简单。一旦我们触发这个状态，就开始动画。如果这里正在进行弹簧动画，我们就用当时的速度作为开始。如果这个弹簧动画是 nil，那么这个开始速度就是 CGPointZero。想要知道为什么依然可以进行动画，可以看看 <code>animationTick:finished:</code> 里的代码。当这个起始速度为 0 的时候，弹力就会使速度缓慢地增长，直到面板到达目标位置：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)didTap:(UITapGestureRecognizer *)tapRecognizer
{
    PaneState targetState = self.paneState == PaneStateOpen ? PaneStateClosed : PaneStateOpen;
    self.paneState = targetState;
    [self startAnimatingView:self.pane initialVelocity:self.springAnimation.velocity];
}
</code></pre></div>
<h3>动画驱动</h3>

<p>最后，我们需要一个 <code>Animator</code>，也就是动画的驱动者。Animator 封装了 display link。因为每个 display link 都链接一个指定的 <code>UIScreen</code>，所以我们根据这个指定的 UIScreen 来初始化我们的 animator。我们初始化一个 display link，并且将它加入到 run loop 中。因为现在还没有动画，所以我们是从暂停状态开始的：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (instancetype)initWithScreen:(UIScreen *)screen
{
    self = [super init];
    if (self) {
        self.displayLink = [screen displayLinkWithTarget:self selector:@selector(animationTick:)];
        self.displayLink.paused = YES;
        [self.displayLink addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSRunLoopCommonModes];
        self.animations = [NSMutableSet new];
    }
    return self;
}
</code></pre></div>
<p>一旦我们添加了这个动画，我们要确保这个 display link 不再是停止状态：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)addAnimation:(id&lt;Animation&gt;)animation
{
    [self.animations addObject:animation];
    if (self.animations.count == 1) {
        self.displayLink.paused = NO;
    }
}
</code></pre></div>
<p>我们设置这个 display link 来调用 <code>animationTick:</code> 方法，在每个 Tick 中，我们都遍历它的动画数组，并且给这些动画数组中的每个动画发送一个消息。如果这个动画数组中已经没有动画了，我们就暂停这个 display link。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> - (void)animationTick:(CADisplayLink *)displayLink
 {
     CFTimeInterval dt = displayLink.duration;
     for (id&lt;Animation&gt; a in [self.animations copy]) {
         BOOL finished = NO;
         [a animationTick:dt finished:&amp;finished];
         if (finished) {
             [self.animations removeObject:a];
         }
     }
     if (self.animations.count == 0) {
         self.displayLink.paused = YES;
     }
 }
</code></pre></div>
<p>完整的项目在 <a href="https://github.com/objcio/issue-12-interactive-animations">GitHub</a> 上。</p>

<h3>权衡</h3>

<p>我们必须记住，通过 display link 来驱动动画 (就像我们刚才演示的例子，或者我们使用UIkit力学来做的例子，又或者是使用 Facebook 的 Pop 框架) 是有代价需要进行权衡的。就像 <a href="https://twitter.com/andy_matuschak/status/464790108072206337">Andy Matuschar 指出的</a>那样，UIView 和 CAAnimation 动画比其他任务更少受系统的影响，因为比起你的应用来说，渲染处于更高的优先级。</p>

<h2>回到 Mac</h2>

<p>现在 Mac 中还没有 UIKit 力学。如果你想在 Mac 中创建一个真实的交互式动画，你必须自己去实现这些动画。我们已经向你展示了如何在 iOS 中实现这些动画，所以在 OS X 中实现相似的功能也是非常简单的。你可以查看在 GitHub 中的<a href="https://github.com/objcio/issue-12-interactive-animations-osx">完整项目</a>，如果你想要应用到 OS X 中，这里还有一些地方需要修改：</p>

<ul>
<li>第一个要修改的就是 <code>Animator</code>。在Mac中没有 <code>CADisplayLink</code>，但是取而代之的有 <code>CVDisplayLink</code>，它是以 C 语言为基础的 API。创建它需要做更多的工作，但也是很直接。</li>
<li>iOS 中的弹簧动画是基于调整 view 的中心位置来实现的。而 OS X 中的 <code>NSView</code> 类没有 center 这个属性，所以我们用为 frame 中的 origin 做动画来代替。</li>
<li>在 Mac 中是没有手势识别，所以我要在我们自定义的 view 子类中实现 <code>mouseDown:</code>，<code>mouseUp:</code> 和 <code>mouseDragged:</code> 方法。</li>
</ul>

<p>上面就是我们需要在 Mac 中使用我们的动画效果在代码所需要做的修改。对于像这样的简单 view，它能很好的胜任。但对于更复杂的动画，你可能就不会想通过为 frame 做动画来实现了，我们可以用 <code>transform</code> 来代替，浏览 Jonathan Willing 写的关于 <a href="http://jwilling.com/osx-animations">OS X 动画</a>的博客，你会获益良多。</p>

<h3>Facebook 的 POP 框架</h3>

<p>上个星期围绕着 Facebook 的 <a href="https://github.com/facebook/pop">POP 框架</a>的讨论络绎不绝。POP 框架是 Paper 应用背后支持的动画引擎。它的操作非常像我们上面讲的驱动动画的例子，但是它以非常灵活的方式巧妙地封装到了一个程序包中。</p>

<p>让我们动手用 POP 来驱动我们的动画吧。因为我们自己的类中已经封装了弹簧动画，这些改变就非常简单了。我们所要做的就是初始化一个 POP 动画来代替我们刚才自己做的动画，并将下面这段代码加入到 view
 中：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">- (void)animatePaneWithInitialVelocity:(CGPoint)initialVelocity
{
    [self.pane pop_removeAllAnimations];
    POPSpringAnimation *animation = [POPSpringAnimation animationWithPropertyNamed:kPOPViewCenter];
    animation.velocity = [NSValue valueWithCGPoint:initialVelocity];
    animation.toValue = [NSValue valueWithCGPoint:self.targetPoint];
    animation.springSpeed = 15;
    animation.springBounciness = 6;
    [self.pane pop_addAnimation:animation forKey:@&quot;animation&quot;];
    self.animation = animation;
}
</code></pre></div>
<p>你可以在 <a href="https://github.com/objcio/issue-12-interactive-animations-pop">GitHub</a> 中找到使用 POP 框架的完整例子。</p>

<p>让其工作非常简单，并且通过它我们可以实现很多更复杂的动画。但是它真正强大的地方在于它能够实现真正的可交互和可中断的动画，就像我们上面提到的那样，因为它直接支持以速度作为输入参数。如果你打算从一开始到被中断这过程中的任何时候都能交互，像 POP 这样的框架就能帮你实现这些动画，并且它能始终保证动画一直很平滑。</p>

<p>如果你不满足于用 <code>POPSpringAnimation</code> 和 <code>POPDecayAnimation</code> 的开箱即用的处理方式的话，POP 还提供了 <code>POPCustomAnimation</code> 类，它基本上是一个 display link 的方便的转换，来在动画的每一个 tick 的回调 block 中驱动你自己的动画。</p>

<h2>展望未来</h2>

<p>随着 iOS7 中从对拟物化的视觉效果的远离，以及对 UI 行为的关注，真实的交互式动画通向未来的大道变得越来越明显。它们也是将初代 iPhone 中滑动行为的魔力延续到交互的各个方面的一条康庄大道。为了让这些魔力成为现实，我们就不能在开发过程中才想到这些动画，而是应该在设计时就要考虑这些交互，这一点非常重要。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-04-24T00:00:00+08:00"><a href="http://morisunshine.com/ios/namespacing/">April 24, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/namespacing/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/namespacing/" rel="bookmark" title="Objective-C的命名空间" itemprop="url">Objective-C的命名空间</a></h1>
    
  </header>
  <div class="entry-description">命名一直是Objective-C的硬伤，和那些优雅的语言相比，Objective-C缺乏标识符容器这点引来了很多不切实际的批评家。 他们总是说：Objective-C不像其他流行语言一样提供模块化机制来避免类名和方法名的冲突。 相反地，Objective-C 依靠前缀来确保APP中的方法名不会影响其他有相同名字的代码。 插入一个关于类型系统的题外话之后我们会继续进入关于命名的讨论。</div>
  <div class="entry-content">
    <div class="full-text"><p>本文由<a href="http://morisunshine.com/">morisunshine</a>译自<a href="http://nshipster.com/namespacing/">&quot;Namespacing&quot;</a>。转载请注明出处！</p>

<blockquote>
<p>为什么Objecive-C中的很多类名都是<code>NS</code>开头的呢？</p>
</blockquote>

<p>我保证在你第一次给别人介绍Objective-C的时候肯定会听到这句话。</p>

<p>就像父母要向孩子解释什么是死亡或者圣诞老人是不存在的问题一样，父母总是寄希望时间会让孩子自己找到答案。</p>

<blockquote>
<p>你既然这么问了，实际上<code>NS</code>代表了<code>NeXTSTEP</code>（好吧，其实是代表<code>NeXTSTEP/Sun</code>，我们只是做个简单的介绍），它被用于...</p>
</blockquote>

<p>你越解释，你会发现对方越失望*，接下来，他们不在只是随便问问了，他们开始问一些你更难解释的问题--在Objective-C中<a href="http://nshipster.com/at-compiler-directives/">@</a>是什么？</p>

<hr>

<p>命名一直是Objective-C的硬伤，和那些优雅的语言相比，Objective-C缺乏标识符容器这点引来了很多不切实际的批评家。</p>

<p>他们总是说：Objective-C不像其他流行语言一样提供模块化机制来避免类名和方法名的冲突。</p>

<p>相反地，Objective-C 依靠前缀来确保APP中的方法名不会影响其他有相同名字的代码。</p>

<p>插入一个关于类型系统的题外话之后我们会继续进入关于命名的讨论。</p>

<h2>C和Objective-C中的类型</h2>

<p>我曾在这个博客上多次提过Objective-C是直接建立在C语言之上的，一个重要的原因是Objective-C和C语言共用一个类型系统，他们都要求标识符是全局唯一的。</p>

<p>你可以自己定义一个和<code>@interface</code>同名的静态变量，编译之后你会得到一个错误：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@interface XXObject : NSObject
@end

static char * XXObject;//将“XXObject”重新定义为不同的符号
</code></pre></div>
<p>也就是说，Objective-C的runtime在C语言的类型系统上又创建了一个抽象层，它甚至可以允许下面这段代码被编译:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@protocol Foo
@end

@interface Foo : NSObject &lt;Foo&gt; {
    id Foo;
}

@property id Foo;
+ (id)Foo;
- (id)Foo;
@end

@interface Foo (Foo)
@end

@implementation Foo
@synthesize Foo;

+ (id)Foo {
    id Foo = @&quot;Foo&quot;;
    return Foo;
}
@end
</code></pre></div>
<ol>
<li>通过Objective-C的环境，程序能区别所有相同名字的类，协议，类别，实例变量，实例方法和类方法。</li>
</ol>

<blockquote>
<p>一个变量能重新调整一个已经存在的方法也是得益与C语言的类型系统（这个有点像一个变量能够隐藏它的隐藏功能）</p>
</blockquote>

<h2>前缀</h2>

<p>在Objective-C应用中的所有类名都必须是全局唯一的。由于很多不同的框架中会有一些相似的功能，所以在名字上也可能会有重复（users， views， requests / responses 等等），所以<a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/Conventions/Conventions.html">苹果官方文档</a>规定类名需要有2-3个字母作为前缀。</p>

<h3>类前缀</h3>

<p><a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/Conventions/Conventions.html">苹果官方建议</a>两个字母作为前缀的类名是为官方的库和框架准备的，而对于作为第三方开发者的我们，官方建议使用3个或者更多的字母作为前缀去命名我们的类。</p>

<p>一个资深的Mac或iOS开发者可能会记得下面大部分的缩写标识符：</p>

<table>
    <thead>
        <tr>
            <th>Prefix</th>
            <th>Frameworks</th>
        </tr>
    </thead>
    <tbody>
        <tr><td><tt>AB</tt></td><td>AddressBook / AddressBookUI</td></tr>
        <tr><td><tt>AC</tt></td><td>Accounts</td></tr>
        <tr><td><tt>AD</tt></td><td>iAd</td></tr>
        <tr><td><tt>AL</tt></td><td>AssetsLibrary</td></tr>
        <tr><td><tt>AU</tt></td><td>AudioUnit</td></tr>
        <tr><td><tt>AV</tt></td><td>AVFoundation</td></tr>
        <tr><td><tt>CA</tt></td><td>CoreAnimation</td></tr>
        <tr><td><tt>CB</tt></td><td>CoreBluetooth</td></tr>
        <tr><td><tt>CF</tt></td><td>CoreFoundation / CFNetwork</td></tr>
        <tr><td><tt>CG</tt></td><td>CoreGraphics / QuartzCore / ImageIO</td></tr>
        <tr><td><tt>CI</tt></td><td>CoreImage</td></tr>
        <tr><td><tt>CL</tt></td><td>CoreLocation</td></tr>
        <tr><td><tt>CM</tt></td><td>CoreMedia / CoreMotion</td></tr>
        <tr><td><tt>CV</tt></td><td>CoreVideo</td></tr>
        <tr><td><tt>EA</tt></td><td>ExternalAccessory</td></tr>
        <tr><td><tt>EK</tt></td><td>EventKit / EventKitUI</td></tr>
        <tr><td><tt>GC</tt></td><td>GameController</td></tr>
        <tr><td><tt>GLK</tt><sup>*</sup></td><td>GLKit</td></tr>
        <tr><td><tt>JS</tt></td><td>JavaScriptCore</td></tr>
        <tr><td><tt>MA</tt></td><td>MediaAccessibility</td></tr>
        <tr><td><tt>MC</tt></td><td>MultipeerConnectivity</td></tr>
        <tr><td><tt>MF</tt></td><td>MessageUI*</td></tr>
        <tr><td><tt>MIDI</tt><sup>*</sup></td><td>CoreMIDI</td></tr>
        <tr><td><tt>MK</tt></td><td>MapKit</td></tr>
        <tr><td><tt>MP</tt></td><td>MediaPlayer</td></tr>
        <tr><td><tt>NK</tt></td><td>NewsstandKit</td></tr>
        <tr><td><tt>NS</tt></td><td>Foundation, AppKit, CoreData</td></tr>
        <tr><td><tt>PK</tt></td><td>PassKit</td></tr>
        <tr><td><tt>QL</tt></td><td>QuickLook</td></tr>
        <tr><td><tt>SC</tt></td><td>SystemConfiguration</td></tr>
        <tr><td><tt>Sec</tt><sup>*</sup></td><td>Security*</td></tr>
        <tr><td><tt>SK</tt></td><td>StoreKit / SpriteKit</td></tr>
        <tr><td><tt>SL</tt></td><td>Social</td></tr>
        <tr><td><tt>SS</tt></td><td>Safari Services</td></tr>
        <tr><td><tt>TW</tt></td><td>Twitter</td></tr>
        <tr><td><tt>UI</tt></td><td>UIKit</td></tr>
        <tr><td><tt>UT</tt></td><td>MobileCoreServices</td></tr>
    </tbody>
</table>

<h4>第三方类前缀</h4>

<p>直到最近，由于<a href="http://cocoapods.org/">CocoaPods</a>的出现和大量新的iOS开发者的涌现，开源代码的遍布，第三方代码在很大程度上对苹果和其余的Objective-C开发社区来说已经不是问题了。最近苹果官方的命名指南也发生了变化，它将三个字母作为前缀的建议只是做为一个习惯做法。</p>

<p>正因为这样，那些已经存在的第三方库依然使用2个字母作为前缀，你可以参考一些那些<a href="https://github.com/search?l=Objective-C&amp;q=stars%3A%3E1&amp;s=stars&amp;type=Repositories">在GitHub上得到很多start的Objective-C的仓库</a>。</p>

<table>
    <thead>
        <tr>
            <th>Prefix</th>
            <th>Frameworks</th>
        </tr>
    </thead>
    <tbody>
        <tr><td><tt>AF</tt></td><td><a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> ("<a href="http://en.wikipedia.org/wiki/Gowalla">Alamofire</a>")</td></tr>
        <tr><td><tt>RK</tt></td><td><a href="https://github.com/RestKit/RestKit">RestKit</a></td></tr>
        <tr><td><tt>GPU</tt></td><td><a href="https://github.com/BradLarson/GPUImage">GPUImage</a></td></tr>
        <tr><td><tt>SD</tt></td><td><a href="https://github.com/rs/SDWebImage">SDWebImage</a></td></tr>
        <tr><td><tt>MB</tt></td><td><a href="https://github.com/jdg/MBProgressHUD">MBProgressHUD</a></td></tr>
        <tr><td><tt>FB</tt></td><td><a href="https://github.com/facebook/facebook-ios-sdk">Facebook SDK</a></td></tr>
        <tr><td><tt>FM</tt></td><td><a href="https://github.com/ccgus/fmdb">FMDB</a> ("<a href="http://flyingmeat.com">Flying Meat</a>")</td></tr>
        <tr><td><tt>JK</tt></td><td><a href="https://github.com/johnezang/JSONKit">JSONKit</a></td></tr>
        <tr><td><tt>FUI</tt></td><td><a href="https://github.com/Grouper/FlatUIKit">FlatUI</a></td></tr>
        <tr><td><tt>NI</tt></td><td><a href="https://github.com/jverkoey/nimbus">Nimbus</a></td></tr>
        <tr><td><tt>RAC</tt></td><td><a href="https://github.com/ReactiveCocoa/ReactiveCocoa">Reactive Cocoa</a></td></tr>
    </tbody>
</table>

<p>我们已经看到在在这个<a href="https://github.com/AshFurrow/AFTabledCollectionView">第三方库</a>的前缀已经和我的<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>一样了，所以最好还是要在你的代码中遵守要三个字母以上的作为类前缀的规定(https://github.com/AshFurrow/AFTabledCollectionView)。</p>

<blockquote>
<p>对于那些针对特殊功能而写的第三方库的作者，可以考虑在下一次主要升级时使用<a href="http://nshipster.com/at-compiler-directives/">@compatibility_alias</a>来为那些使用者们提供一个天衣无缝的转移路径。</p>
</blockquote>

<h2>方法前缀</h2>

<p>不仅是类容易造成命名冲突，selectors也很容易造成命名冲突，甚至方法比类会有更多的问题。
考虑一下这个category：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@interface NSString (PigLatin)
- (NSString *)pigLatinString;
@end
</code></pre></div>
<p>如果 <code>-pigLatinString</code>方法被另一个category实现了（或者以后版本的iOS或者Mac OS X 在NSString类中也添加了同样名字的方法），那么调用这个方法就会得到未定义的行为错误，因为我们不能保证在runtime中哪个方法会先被定义。</p>

<p>我们可以通过在方法名前加前缀来避免这个问题，就像加这个类名一样（在类别名前加前缀也是个好办法）：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@interface NSString (XXXPigLatin)
- (NSString *)xxx_pigLatinString;
@end
</code></pre></div>
<p>苹果官方建议<a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html#//apple_ref/doc/uid/TP40011210-CH6-SW4">所有category方法都要使用前缀</a>，这个建议比类名需要加前缀的规定更加广为人知和接受。</p>

<p>很多开发者都在热情地讨论着这个规定的某一方面。然而，无论是通过成本角度还是效益角度来衡量命名冲突风险的可能性都是是不全面的:</p>

<p>category的主要功能是通过语法糖将一些有用的功能包裹进原来的类中。任何一个category方法都可以被选择性实现，你也可以把他当做是self的一个隐型功能方法。</p>

<p>当我在编译器的环境参数中将<code>OBJC_PRINT_REPLACED_METHODS</code>这个参数设置为YES，那我们就能在编译的时候检测方法名是否有冲突。实际上，方法名的冲突是很少发生的，而且在发生的时候，他们通常会得到一个<code>needlessly duplicated across dependencies</code>的提示。即使发生最坏的情况，程序在运行是出现异常，那么很可能是两个方法名一样，那么他们<em>做</em>的事情也是一样的，所以结果也不会有什么变化。就像Swiss Army Knife写了一个category，他定义了<code>NSArray</code>中的<code>-firstObject</code>这个方法，那么只要苹果官方没有在<code>NSArray</code>中加这个方法的话，那么这个类别方法一直有效的。</p>

<p>在苹果官方的编程指南中有很多严肃又松散的解释。这里没有固定的文档，他们可能一直变化。看到这里，如果你还是悬而未决，那么你只需要把的category方法名加上前缀，如果你还是选择不去做任何改变，那么你就等着自食其果吧。</p>

<blockquote>
<p>继续添加“category 方法”到你的Tweetbot条款。有效期:一个星期</p>
</blockquote>

<h3>Swizzling</h3>

<p>在Swizzling时，方法名加前缀或者后缀也是非常有必要的，这个我在上周关于<a href="http://nshipster.com/method-swizzling/">swizzling</a>的文章中提到过。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@implementation UIViewController (Swizzling)

- (void)xxx_viewDidLoad {
    [self xxx_viewDidLoad];

    // Swizzled implementation
}
</code></pre></div>
<h2>我们真的需要命名空间么？</h2>

<p>在最近关于Objective-C替换、改造和重塑的讨论中，我可以明显地发现命名空间是未来的一个趋势。但是它到底给我们带来了什么呢？</p>

<p><strong>美学</strong>？除了IETE成员和军事人员，我想没有人会喜欢<acronym title="CAPITAL LETTER ACRONYMS">CLA</acronym>s的视觉审美，但是用<code>::</code>，<code>/</code>或者另外的<code>.</code>这些符号真的能让我们觉得更好么？你<em>真的</em>想要以后把<code>NSArray</code>叫做&quot;Foundation Array&quot;？（那我这个NSHipster.com这个博客不是也得改名字了?!）</p>

<p><strong>语义学</strong>？让我们比较一下其他的语言，看看他们是怎么用命名空间的，那么你就会意识到命名空间不能解决所有不明确的问题。可能在某些额外环境的情况下，那些命名空间会出现更多问题。</p>

<p>你还是不赞同，那么你想象一下Objective-C的命名空间的实现可能会像这个样子，你会觉得怎么样:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@namespace XX
    @implementation Object

    @using F: Foundation;

    - (void)foo {
        F:Array *array = @[@1,@2, @3];

        // ...
    }

    @end
@end
</code></pre></div>
<p>虽然Objective-C有繁琐的代码但也有容易理解的明显优点。我们作为开发者去讨论<code>NSString</code>的时候，我们不会把它理解成别的意思，编译器也是一样。当我们在阅读代码时，我们不需要过多地去考虑这些代码是什么作用的。并且最重要的是，NSString这个类名在google这些搜索引擎中<a href="http://lmgtfy.com/?q=NSString">很容易就可以找到， 你不会得到其他结果</a>。</p>

<p>不管怎样，如果你对这个讨论感兴趣的话，我强烈建议你看一下<a href="http://optshiftk.com/">Kyle Sluder</a>的<a href="http://optshiftk.com/2012/04/draft-proposal-for-namespaces-in-objective-c/">this namespace feature proposal</a>。非常值得一看。</p>
</div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta"><span class="entry-date date published updated"><time datetime="2014-04-22T00:00:00+08:00"><a href="http://morisunshine.com/ios/ios_code_standards/">April 22, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="http://morisunshine.com/about/" title="About Sheldon">Sheldon</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://morisunshine.com/ios/ios_code_standards/#disqus_thread">Comment</a></span></div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://morisunshine.com/ios/ios_code_standards/" rel="bookmark" title="iOS编码规范参考" itemprop="url">iOS编码规范参考</a></h1>
    
  </header>
  <div class="entry-description">经常说没有最好的风格，只有统一风格，所以编码规范就是为了统一我们的编码风格。而在这里我对我平时使用的编码规范进行了一个总结，希望能给大家提供参考</div>
  <div class="entry-content">
    <div class="full-text"><p>经常说没有最好的风格，只有统一风格，所以编码规范就是为了统一我们的编码风格。而在这里我对我平时使用的编码规范进行了一个总结，希望能给大家提供参考</p>

<h2>注释</h2>

<p>建议使用<a href="https://github.com/onevcat/VVDocumenter-Xcode">VVDocumenter</a>插件</p>

<h3>多行注释</h3>

<p>格式:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">/**

              注释内容
*/
</code></pre></div>
<h3>单行注释</h3>

<p>格式:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">///在对文件、类、函数进行注释时推荐使用多行注释，在函数体内对代码块进行注释时，使用单行注释
</code></pre></div>
<h3>函数的注释</h3>

<p>函数注释的格式为</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">/**
 *  @brief  
 *  @param
 *  @return
 **/
 在brief中需要写明函数的主要功能、注意事项
 在param中需要写明函数的变量类型、变量的作用
 在return中需要写明函数的返回类型、返回值的作用
 如有其他需要说明的地方，可以在@return后面添加新项。如
 /**
 *  @brief  
 *  @param
 *  @return
 *  @warning
 **/

/**
 *  @brief      上传图片。上传成功后会自动将图片放入缓存，缓存的key为图片的url
 *  @param      UIImage，需要上传的图片
 *  @return     void
 *  @blocks
 *              success:返回的NSDictionary中包含服务器的response信息，包括图片id（id）,url(url),宽度(width),高度(height)。使用括号中的名称从NSDictionary中获取。
 *              failed:返回error
 **/
</code></pre></div>
<h2>命名</h2>

<h3>常量的命名</h3>

<p>(如宏、枚举、静态局部变量等)应该以小写字母k开头，使用混合大小写的格式来分隔单词。</p>

<h3>函数的命名</h3>

<p>函数名应该已小写字母开头，并混合大小写，其中的每个参数都应该是小写字母开头，读起来应该像句子一样，访问器方法应该与他们getting的成员变量的名字一样，但不应该以get作为前缀，如：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">  - (id)getDelegate;    //avoid
  - (id)delegate;       //good
</code></pre></div>
<h3>变量的命名</h3>

<p>成员变量应该已小写字母开头，并以下划线作为后缀，如usernameTextField_,使用KVO/KVC绑定成员变量时，可以以一个下划线为前缀。</p>

<blockquote>
<p>公共变量命名:
小写字母开头。如:imageView;</p>

<p>实例变量命名:</p>

<p>私有变量:
应该以下划线开头。如:_addButton</p>

<p>常量命名:
以小写k开头，混合大小写。如:kInvalidHandle, kWritePerm</p>
</blockquote>

<h3>图片的命名</h3>

<p>应该已“模块+功能+作用+样式”的形式</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:message_private_at_button_bg_normal.png
</code></pre></div>
<h3>类的命名</h3>

<p>类名、分类名、协议名应该以大写字母开始，并混合小写字母来分隔单词，应该已“模块+功能+子功能”的方式：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:MessagePrivateAtsomebody
</code></pre></div>
<p>应用级的类，应避免不用前缀，跨应用级的类，应使用前缀，
<code>objc
如:GTMSendMessage
</code></p>

<h2>分类名</h2>

<p>类别名应该有两三个字母作为前缀已表示为某项目的一部分，并且包含所扩展的类的名字，如我们要创建一个NSString的类别以解析，我们将类别放在一个名为GTMNSString+Parsing.h的文件中。类别名本身为GTMStringParsingAdditions(类别名与文件名不同是为了让文件可以包含更多相同功能的扩展)类名与包含类别名之间应一个空格分隔。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
//NSString 为要扩展的类名, GTMStringParsingAdditions为类别名
@interface NSString (GTMStringParsingAdditions)
        - (NSString *)gtm_foobarString;
        @end

        @interface FoobarViewController ()
        @property(nonatomic, retain) NSView *dongleView;
        - (void)performLayout;
        @end
</code></pre></div>
<h2>注意事项</h2>

<h3>条件语句</h3>

<p>为避免错误，条件语句体必须使用大括号，即便语句体中的语句可以不必使用大括号（比如只有一行语句）。常见的错误包括在不使用大括号的情况下添加第二行语句，以为它属于if语句的一部分。此外，更可怕的事情是，如果条件语句中的代码行被注释，则本不术语条件语句的下一行代码将变成条件语句的一部分。此外，这种编码风格和所有其它条件语句均保持一致。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
if (!error) {
    return success;
}
</code></pre></div>
<h3>变量</h3>

<p>变量的命名应尽可能具有自解释性。除了在for()循环语句中，应避免使用单个字母变量名称。
除非是常量，星号应紧贴变量名称表示指向变量的指针，
<code>objc
如:
NSString *text;
</code></p>

<p>应尽可能使用属性定义替代单一的实例变量。避免在初始化方法,dealloc方法和自定义的setter和getter方法中直接读取实例变量参数（init,initWithCoder:，等等）</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
@interface NYTSection: NSObject

@property (nonatomic) NSString *headline;

@end

应尽量避免下面的方式:

@interface NYTSection : NSObject {
    NSString *headline;
}
</code></pre></div>
<h3>下划线</h3>

<p>当使用属性变量时，应通过self.来获取和更改实例变量。这就意味着所有的属性将是独特的，因为它们的名称前会加上self。本地变量名称中不应包含下划线</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
self.imgView.backgroundColor = [UIColor black];

而尽量避免:

_imgView.backgroundColor = [UIColor black];
</code></pre></div>
<h3>Immutable实例初始化</h3>

<p>在创建NSString,NSDictionary,NSArray和NSNumber等对象的immutable实例时，应使用字面量。需要注意的是，不应将<strong><em>nil</em></strong>传递给NSArray和NSDictionary字面量，否则会引起程序崩溃。所以在存入数据到NSArray和NSDictionary时也要判断一下数据是否是nil。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">NSArray *names = @[@&quot;Brian&quot;, @&quot;Matt&quot;, @&quot;Chris&quot;, @&quot;Alex&quot;, @&quot;Steve&quot;, @&quot;Paul&quot;];
NSDictionary *productManagers = @{@&quot;iPhone&quot; : @&quot;Kate&quot;, @&quot;iPad&quot; : @&quot;Kamal&quot;, @&quot;Mobile Web&quot; : @&quot;Bill&quot;};
NSNumber *shouldUseLiterals = @YES;
NSNumber *buildingZIPCode = @10018;

不恰当:
NSArray *names = [NSArray arrayWithObjects:@&quot;Brian&quot;, @&quot;Matt&quot;, @&quot;Chris&quot;, @&quot;Alex&quot;, @&quot;Steve&quot;, @&quot;Paul&quot;, nil];
NSDictionary *productManagers = [NSDictionary dictionaryWithObjectsAndKeys: @&quot;Kate&quot;, @&quot;iPhone&quot;, @&quot;Kamal&quot;, @&quot;iPad&quot;, @&quot;Bill&quot;, @&quot;Mobile Web&quot;, nil];
NSNumber *shouldUseLiterals = [NSNumber numberWithBool:YES];
NSNumber *ZIPCode = [NSNumber numberWithInteger:10018];
</code></pre></div>
<h3>类型</h3>

<p>最好用NSInteger和NSUInteger而不是用int，long。其他的float同理。</p>

<h3>CGRect函数</h3>

<p>当需要获取一个CGRect矩形的x,y,width,height属性时，应使用CGGeometry函数，而非直接访问结构体成员。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如：
CGRect frame = self.view.frame;

CGFloat x = CGRectGetMinX(frame);
CGFloat y = CGRectGetMinY(frame);
CGFloat width = CGRectGetWidth(frame);
CGFloat height = CGRectGetHeight(frame);

不恰当：
CGRect frame = self.view.frame;

CGFloat x = frame.origin.x;
CGFloat y = frame.origin.y;
CGFloat width = frame.size.width;
CGFloat height = frame.size.height;
</code></pre></div>
<h3>常量</h3>

<p>相对字符串字面量或数字，我们更推荐适用常量。应使用static方式声明常量，而非使用#define的方式来定义宏。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">例如：
static NSString * const NYTAboutViewControllerCompanyName = @&quot;The New York Times Company&quot;;  
static const CGFloat NYTImageThumbnailHeight = 50.0;

不恰当:
//#define CompanyName @&quot;The New York Times Company&quot;
//#define thumbnailHeight 2
</code></pre></div>
<h3>枚举类型</h3>

<p>在使用enum的时候，推荐适用最新的fixed underlying type(WWDC 2012 session 405- Modern Objective-C)规范，因为它具备更强的类型检查和代码完成功能。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如：
typedef NS_ENUM(NSInteger, NYTAdRequestState) {
    NYTAdRequestStateInactive,
    NYTAdRequestStateLoading
};
</code></pre></div>
<h3>布尔变量</h3>

<p>因为nil将被解析为NO，因此没有必要在条件语句中进行比较。永远不要将任何东西和YES进行直接比较，因为YES被定义为1，而一个BOOL变量可以有8个字节。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如：
if (!someObject) {
}

if (isAwesome)

if (![someObject boolValue])

不恰当：
if (someObject == nil) {
}

if ([someObject boolValue] == NO)

if (isAwesome == YES) // Never do this.
</code></pre></div>
<p>如果一个BOOL属性使用形容词来表达，属性将忽略’is’前缀，但会强调惯用名称。
例如：</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">@property (assign, getter=isEditable) BOOL editable;
</code></pre></div>
<h3>单例</h3>

<p>在创建单例对象的共享实例时，应使用线程安全模式。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如：
(instancetype)sharedInstance {
   static id sharedInstance = nil;

   static dispatch_once_t onceToken;
   dispatch_once(&amp;onceToken, ^{
      sharedInstance = [[self alloc] init];
   });

   return sharedInstance;
}
</code></pre></div>
<h3>数字</h3>

<p>尽量避免数字固定为某个类型如:写5而不写5.0，5.3而不写5.3f)</p>

<h3>代码组织</h3>

<p>用 <code>#pragma mark</code>来将方法分类，这个非常有效，当你用快捷键<code>Control+6</code>可以高效的寻找到自己想要跳转到的方法</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">//#pragma mark Properties

@dynamic someProperty;

- (void)setCustomProperty:(id)value {}

#pragma mark Lifecycle

+ (id)objectWithThing:(id)thing {}
- (id)init {}

#pragma mark Drawing

#pragma mark UItableView delegate

#pragma mark UITableView datasource

- (void)drawRect:(CGRect) {}

#pragma mark Another functional grouping

#pragma mark GHSuperclass

- (void)someOverriddenMethod {}

#pragma mark NSCopying

- (id)copyWithZone:(NSZone *)zone {}

#pragma mark NSObject

- (NSString *)description {}
</code></pre></div>
<h3>判断语句</h3>

<p>if和else应该和左大括号在同一行</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
if (button.enabled) {
    // Stuff
} else if (otherButton.enabled) {
    // Other stuff
} else {
    // More stuf
}
</code></pre></div>
<p>Switch 也是一样</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
switch (something.state) {
    case 0: {
        // Something
        break;
    }

    case 1: {
        // Something
        break;
    }

    case 2:
    case 3: {
        // Something
        break;
    }

    default: {
        // Something
        break;
    }
}
</code></pre></div>
<h3>Import</h3>

<p>在类的头文件中需要引用其他的类的时候，需要用<code>@class</code>这个关键字，这样能减少类与类之间的依赖。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
store.h:

#import &lt;Foundation/Foundation.h&gt;
#import &lt;CoreData/CoreData.h&gt;

@class User;

@interface Store : NSManagedObject

@property (nonatomic, retain) User *user;

@end

Store.m:

#import &quot;Store.h&quot;

#import &quot;User.h&quot;

@implementation Store

//doSomething

@end
</code></pre></div>
<h3>私有方法</h3>

<p>关于私有方法，苹果官方建议呢是是使用统一的前缀来分组和辨识。但是千万不用用下划线来作为前缀来命名，或者你可以在前缀前添加一些特殊的标识。</p>

<h2>git commit 格式</h2>

<p>可以参考<a href="https://docs.google.com/document/d/1QrDFcIiPjSLDn3EL15IJygNPiHORgU1_OOAqWjiDU5Y/edit#">google开源项目的Commit 规范</a></p>

<p>参考规范:</p>

<ol>
<li><strong>添加了新功能</strong> <code>feat(大模块+子模块):#例如实现了某个具体功能</code></li>
<li><strong>修改了某些功能</strong>  <code>change(大模块+子模块):#例如修改了某个具体的功能</code></li>
<li><strong>修复了某个Bug</strong>  <code>fix_bug(大模块+子模块):#修复了什么的bug，最好写上*原因*和*解决方法*。</code></li>
<li><p><strong>比较大的改动</strong>
```
broken_change():
before: </p>

<p>after:
```</p></li>
<li><p><strong>修改了文档</strong> <code>docs():</code></p></li>
<li><p><strong>修改了格式</strong> <code>style():</code></p></li>
<li><p><strong>添加了一些测试</strong> <code>test(大模块+子模块):</code></p></li>
<li><p><strong>一些杂项，比如像解决工程编译错误等问题之后的修改</strong> <code>chore():</code></p></li>
<li><p><strong>对又有代码的重构</strong> <code>refactor(大模块+子模块):</code></p></li>
</ol>

<h2>格式</h2>

<p>一行代码的长度不能超过80个字母</p>

<p><strong>函数声明和定义:</strong></p>

<p>“-”或“+”和返回类型之间应该有一个空格</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
- (void)doSomethingWithString:(NSString *)theString {
  ...
}
</code></pre></div>
<p>方法大括号和其它大括号（比如if/else/switch/while等等）应在语句的同一行开始，而在新的一行关闭。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">if (user.isHappy) {
//Do something
}
else {
//Do something else
}
</code></pre></div>
<p>当有多个参数的时，如果参数太多超过一行，则应该将每个参数分行，并且冒号对齐</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
- (void)doSomethingWith:(GTMFoo *)theFoo
                   rect:(NSRect)theRect
               interval:(float)theInterval {
  ...
}
</code></pre></div>
<p>当第一个参数短于其他参数的时候，分行时每行至少要缩进4个空格</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">             longKeyword:(NSRect)theRect
       evenLongerKeyword:(float)theInterval
                   error:(NSError **)theError {
          ...
}
</code></pre></div>
<h3>方法调用</h3>

<p>方法调用应该和方法声明的时候一个格式,要么所有参数放在一行里:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">[myObject doFooWith:arg1 name:arg2 error:arg3];
</code></pre></div>
<p>要么每一行一个参数:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
[myObject doFooWith:arg1
               name:arg2
              error:arg3];
</code></pre></div>
<p>当第一个参数短语其他参数的时候，分行是每行至少要缩进4个空格:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
[myObj short:arg1
          longKeyword:arg2
    evenLongerKeyword:arg3
                error:arg4];

</code></pre></div>
<p>@public 和 @private前面为一个空格</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
@interface MyClass : NSObject{
 @public
 …
 @private
}
@end
</code></pre></div>
<h3>协议</h3>

<p>类型与协议名之间不要空格</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">如:
@interface MyProtocoledClass : NsObject&lt;NSWindowDelegate&gt; {
 @private
  id&lt;MyFancyDelegate&gt; _delegate;
}
-  (void)setDelegate:(id&lt;MyFancyDelegate&gt;)aDelegate;
@end
</code></pre></div>
<h3>Blocks</h3>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc">在一行的情况
如:
[operation setCompletionBlock:^{ [self onOperationDone]; }];

//block 在新的行里，需要缩进四个空格
[operation setCompletionBlock:^{
      [self.delegate newDataAvailable];
}];

dispatch_async(_fileIOQueue, ^{
      NSString* path = [self sessionFilePath];
      if (path) {
        // ...
      }
});
</code></pre></div><div class="highlight"><pre><code class="objc language-objc" data-lang="objc">//有参数的block,|(SessionWindow *window)|与|{|之间有一个空格
如:
[[SessionService sharedService]
    loadWindowWithCompletionBlock:^(SessionWindow *window) {
        if (window) {
          [self windowDidLoad:window];
        } else {
          [self errorLoadingWindow];
        }
    }];

//block 中有参数且不能在一行中显示
//要行与行之间要相对有四个空格
[[SessionService sharedService]
      loadWindowWithCompletionBlock:
            ^(SessionWindow *window) {
                   if (window) {
                     [self windowDidLoad:window];
                   } else {
                     [self errorLoadingWindow];
                   }
            }];

//很长的block可以被定义不在一行里
void (^largeBlock)(void) = ^{
    // ...
};
[_operationQueue addOperationWithBlock:largeBlock];
</code></pre></div></div>
    <div class="collapse-text"></div>
    <div class="collapse-toggle"></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->


<style type="text/css">body {background-image:url(/images/witewall_3.png);}</style>

<div class="pagination">
  
    Previous
  
  <ul class="inline-list">
    <li>
      
        <span class="current-page">1</span>
      
    </li>
    
      <li>
        
          <a href="http://morisunshine.com/page2">2</a>
        
      </li>
    
      <li>
        
          <a href="http://morisunshine.com/page3">3</a>
        
      </li>
    
  </ul>
  
    <a href="http://morisunshine.com/page2" class="btn">Next</a>
  
</div><!-- /.pagination -->
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Sheldon. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://morisunshine.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://morisunshine.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-47868064-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script src="/assets/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

          


</body>
</html>