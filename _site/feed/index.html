<?xml version="1.0" encoding="utf-8"?>
  <rss version="2.0"
        xmlns:content="http://purl.org/rss/1.0/modules/content/"
        xmlns:atom="http://www.w3.org/2005/Atom"
  >
  <channel>
    <title>morisunshine</title>
    <link href="http://morisunshine.com/feed/" rel="self" />
    <link href="http://morisunshine.com" />
    <lastBuildDate>2014-02-28T15:30:28+08:00</lastBuildDate>
    <webMaster>allenwenzhou@gmail.com</webMaster>
    
    <item>
      <title>UICollectionView+UIKit Dynamics</title>
      <link href="http://morisunshine.com/2014/02/27/UICollectionView_UIKit_Dynamics/"/>
      <pubDate>2014-02-27T00:00:00+08:00</pubDate>
      <author>morisunshine</author>
      <guid>http://morisunshine.com/2014/02/27/UICollectionView_UIKit_Dynamics</guid>
      <content:encoded><![CDATA[<p>本文有<a href="www.morisunshine.com">morisunshine</a>译自<a href="http://www.objc.io/issue-5/collection-views-and-uidynamics.html">objc.io</a>,原文作者<a href="https://twitter.com/ashfurrow">Ash Furrow</a>。转载请注明出处！</p>

<p>UIKit Dynamics 是iOS7中基于物理动画引擎的一个新特征--它被特别设计使其能很好地与collection Views配合工作，collection View首次在iOS6中被介绍。我们将进行一个将他们两个结合之旅。  </p>

<p>这篇文章将讨论两个实现了UIkit Dynamics的collection views的例子。第一个例子展示了如何去实现像iOS7里<code>Messages</code>应用中的弹力效果，然后进一步结合了有可伸缩效果的平铺机制。第二个例子展现了如何用UIKit Dynamics来模拟牛顿摆，事例可以一次被添加到collection view，然后相互作用。</p>

<p>在我们开始之前，我假定你们对<code>UICollectionView</code>是如何工作的有了基本的了解--查看<a href="http://www.objc.io/issue-3/collection-view-layouts.html">这篇objc.io博客</a>会有你想要的所有细节。我也假定你已经理解了<code>UIKit Dynamics</code>的工作原理--阅读这篇<a href="http://www.teehanlax.com/blog/introduction-to-uikit-dynamics/">博客</a>。</p>

<p>文章中的两个例子项目都已经在GitHub中:</p>

<ul>
<li><a href="https://github.com/objcio/issue-5-springy-collection-view">ASHSpringyCollectionView</a>(基于<a href="https://github.com/TeehanLax/UICollectionView-Spring-Demo">UICollectionView Spring Demo</a>)</li>
<li><a href="https://github.com/objcio/issue-5-newtonian-collection-view">Newtownian UICollectionView</a></li>
</ul>

<h1>The Dynamic Animator</h1>

<p>支持UICollectionView应用UIkit Dynamic的最关键部分就是UIDynamicAnimator。这个类是在UICollectionViewFlowLayout对象中，并且是被强引用的(有些人终究需要保持这个animator)。</p>

<p>当我们创建我们自己的dynamic animator，我们不会想平常一样，给它一个引用的试图。相反的，我们会用到需要collection view 布局作为参数的初始化程序。这很关键，当他的行为物理的属性应该被更新的时候，dynamic animator必须能够使collection view 布局无效。换句话说，dynamic animator 将会使布局无效。</p>

<p>我们将会很快看到事情是怎么连接起来的，但是在概念上理解collection view 如何与 dynamic animator相互作用是很重要的。collection view 布局将要在这个collection view 中的每个UICollectionViewLayoutAttributes对象添加行为(过会儿我们将讨论tiling这些)。将这些行为添加到dyamic animator之后，UIKit就会以查询这个collection view 布局属性的状态查询这个collection view 布局。与我们自己做大量计算相反，我们将返回这些被dynamic animator提供的物品。一旦animator的模拟状态发生改变，这个animator就会使这个布局无效。这会导致UIKit重新查询这个布局，并且一直循环到这个模拟静止。</p>

<p>所以重申一下，这个布局创建dynamic animator并且添加行为要与它每个物品中的布局属性相一致。当被问及布局信息时，它提供了由dynamic animator提供的信息。</p>

<h1>继承UICollectionViewFlowLayout</h1>

<p>我们将要创建一个简单的例子来展示入如何使用带一个collection view 布局的UIkit Dynamic。我们需要做的第一件事就是，当然，一个数据源去驱动我们的collection view。我知道你聪明的可以提供自己的数据源，但是为了完整性，我还是提供了一个给你:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">@implementation</span> <span class="nc">ASHCollectionViewController</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span> <span class="n">CellIdentifier</span> <span class="o">=</span> <span class="s">@&quot;CellIdentifier&quot;</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> 
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="n">registerClass</span><span class="o">:</span><span class="p">[</span><span class="n">UICollectionViewCell</span> <span class="n">class</span><span class="p">]</span> 
            <span class="n">forCellWithReuseIdentifier</span><span class="o">:</span><span class="n">CellIdentifier</span><span class="p">];</span>

<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="nf">preferredStatusBarStyle</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="n">UIStatusBarStyleLightContent</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidAppear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> 
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidAppear</span><span class="o">:</span><span class="n">animated</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionViewLayout</span> <span class="n">invalidateLayout</span><span class="p">];</span>

<span class="p">}</span>

<span class="cp">#pragma mark - UICollectionView Methods</span>

<span class="k">-</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> 
    <span class="nf">numberOfItemsInSection:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">120</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> 
                 <span class="nf">cellForItemAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> 
<span class="p">{</span>
    <span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">collectionView</span> 
        <span class="n">dequeueReusableCellWithReuseIdentifier</span><span class="o">:</span><span class="n">CellIdentifier</span> 
                                  <span class="n">forIndexPath</span><span class="o">:</span><span class="n">indexPath</span><span class="p">];</span>

    <span class="n">cell</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">orangeColor</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>注意到当试图被第一次出现的时候，这个布局是被无效的。这是因为没有用Storybards的结果(当使用Storyboards时，调用prepareLayout方法的时机是不同的--或是相同的--在WWDC的视频中他们没有告诉我们这些)。结果，一旦这些试图出现我们就需要手动使这个collection view 布局无效。当我们用tiling的时候，就不需要这样。</p>

<p>让我们创建我们的collection view 布局。我们需要一个指向dynamic animator的强引用，它将推动我们的collection view布局的属性。我们将有一个私有属性被定义在这个实现文件里:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">ASHSpringyCollectionViewFlowLayout</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIDynamicAnimator</span> <span class="o">*</span><span class="n">dynamicAnimator</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div>
<p>我们将在布局的初始化方法中初始我们的dynamic animator。还要设置一些属于父类UICollectionViewFlowLayout中的属性:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">]))</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">self</span><span class="p">.</span><span class="n">minimumInteritemSpacing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">minimumLineSpacing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">itemSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">44</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">sectionInset</span> <span class="o">=</span> <span class="n">UIEdgeInsetsMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIDynamicAnimator</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithCollectionViewLayout</span><span class="o">:</span><span class="n">self</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>
<p>我们将实现的下一个方法是prepareLayout。我们需要先调用父类的方法。因为我们是继承UICollectionViewFlowLayout，调用父类的prepareLayout将会为我们使collection view 布局属性都放置在合适的位置。我们现在可以依靠他们来排布并且要求所有的属性都在指定的范围内。让我们加载所有。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="p">[</span><span class="n">super</span> <span class="n">prepareLayout</span><span class="p">];</span>

<span class="n">CGSize</span> <span class="n">contentSize</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">.</span><span class="n">contentSize</span><span class="p">;</span>
<span class="n">NSArray</span> <span class="o">*</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">layoutAttributesForElementsInRect</span><span class="o">:</span>
    <span class="n">CGRectMake</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">height</span><span class="p">)];</span>
</code></pre></div>
<p>这真的是很没效率的代码。因为我们的collection view能够有成千上万个cell，一次性加载所有的cell会可能会导致难以置信的内存问题--频繁操作。我们要立刻遍历所有的元素，使这也成为耗时的操作。效率的双重打击！别担心--我们是负责任的开发者，所以我们会很快解决这个问题的。现在，我们继续简单的、朴素的实现方式。</p>

<p>加载完我们所有的collection view 布局属性之后，我们需要查看他们是否已经被加载到我们的animator里了。如果一个物品的行为已经在animator中存在，那么我么就不能重新添加，否则就会得到一个非常难懂的运行异常。</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="o">&lt;</span><span class="n">UIDynamicAnimator</span><span class="o">:</span> <span class="mh">0xa5ba280</span><span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.004987</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> 
<span class="o">&lt;</span><span class="n">ASHSpringyCollectionViewFlowLayout</span><span class="o">:</span> <span class="mh">0xa5b9e60</span><span class="o">&gt;</span> <span class="err">\</span><span class="p">{</span><span class="err">\</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="err">\</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="err">\</span><span class="p">}</span><span class="err">\</span><span class="p">}</span><span class="o">:</span> 
<span class="n">body</span> <span class="o">&lt;</span><span class="n">PKPhysicsBody</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">:&lt;</span><span class="n">Rectangle</span><span class="o">&gt;</span> <span class="n">representedObject</span><span class="o">:</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">UICollectionViewLayoutAttributes</span><span class="o">:</span> <span class="mh">0xa281880</span><span class="o">&gt;</span> 
<span class="n">index</span> <span class="n">path</span><span class="o">:</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">NSIndexPath</span><span class="o">:</span> <span class="mh">0xa281850</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">0</span><span class="p">});</span> 
<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="mi">10</span><span class="p">;</span> <span class="mi">300</span> <span class="mi">44</span><span class="p">);</span> <span class="p">]</span> <span class="mh">0xa2877c0</span>  
<span class="nl">PO:</span><span class="p">(</span><span class="mf">159.999985</span><span class="p">,</span><span class="mf">32.000000</span><span class="p">)</span> <span class="n">AN</span><span class="o">:</span><span class="p">(</span><span class="mf">0.000000</span><span class="p">)</span> <span class="n">VE</span><span class="o">:</span><span class="p">(</span><span class="mf">0.000000</span><span class="p">,</span><span class="mf">0.000000</span><span class="p">)</span> <span class="n">AV</span><span class="o">:</span><span class="p">(</span><span class="mf">0.000000</span><span class="p">)</span> 
<span class="nl">dy:</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">cc</span><span class="o">:</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">ar</span><span class="o">:</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">rs</span><span class="o">:</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">fr</span><span class="o">:</span><span class="p">(</span><span class="mf">0.200000</span><span class="p">)</span> <span class="n">re</span><span class="o">:</span><span class="p">(</span><span class="mf">0.200000</span><span class="p">)</span> <span class="n">de</span><span class="o">:</span><span class="p">(</span><span class="mf">1.054650</span><span class="p">)</span> <span class="n">gr</span><span class="o">:</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
<span class="n">without</span> <span class="n">representedObject</span> <span class="k">for</span> <span class="n">item</span> <span class="o">&lt;</span><span class="n">UICollectionViewLayoutAttributes</span><span class="o">:</span> <span class="mh">0xa3833e0</span><span class="o">&gt;</span> 
<span class="n">index</span> <span class="n">path</span><span class="o">:</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">NSIndexPath</span><span class="o">:</span> <span class="mh">0xa382410</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">0</span><span class="p">});</span> 
<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="mi">10</span><span class="p">;</span> <span class="mi">300</span> <span class="mi">44</span><span class="p">);</span>
</code></pre></div>
<p>如果看到这个错误，那么这基本表明你添加了两个行为给同一个UICollectionViewLayoutAttributes，这导致了系统不知道该怎么处理。</p>

<p>无论如何，一旦我们已经检查好我们是否已经将行为添加到dynamic animator之后，我们就需要遍历每个collection view 布局属性来创建和添加新的dynamic behavior:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span><span class="p">.</span><span class="n">behaviors</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">items</span> <span class="n">enumerateObjectsUsingBlock</span><span class="o">:^</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">UIDynamicItem</span><span class="o">&gt;</span> <span class="n">obj</span><span class="p">,</span> <span class="n">NSUInteger</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIAttachmentBehavior</span> <span class="o">*</span><span class="n">behaviour</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAttachmentBehavior</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithItem</span><span class="o">:</span><span class="n">obj</span> 
                                                                    <span class="n">attachedToAnchor</span><span class="o">:</span><span class="p">[</span><span class="n">obj</span> <span class="n">center</span><span class="p">]];</span>

        <span class="n">behaviour</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
        <span class="n">behaviour</span><span class="p">.</span><span class="n">damping</span> <span class="o">=</span> <span class="mf">0.8f</span><span class="p">;</span>
        <span class="n">behaviour</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span> <span class="n">addBehavior</span><span class="o">:</span><span class="n">behaviour</span><span class="p">];</span>

    <span class="p">}];</span>

<span class="p">}</span>
</code></pre></div>
<p>这段代码非常简单，我们为每个物品创建了一个以物品的中心为附着点的新UIAttachmentBehavior。然后又设置了我们的附着行为到零点的长度以便约束这个cell能一直以行为的附着点为中心。然后又设置阻尼和频率为这些值，这些值是我为了赏心悦目和不过份而实验性决定的。</p>

<p>这就是prepareLayout。我们现在需要实现两个方法，UIKit会调用它们来查询关于collection view 布局属性的布局，layoutAttributesForElementsInRect: 和 layoutAttributesForItemAtIndexPath:。我们的实现将会促进这些查询指向这个有专门设计的方法来响应这些查询的dynamic animator:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForElementsInRect:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">rect</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span> <span class="n">itemsInRect</span><span class="o">:</span><span class="n">rect</span><span class="p">];</span>

<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span> <span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForItemAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span> <span class="n">layoutAttributesForCellAtIndexPath</span><span class="o">:</span><span class="n">indexPath</span><span class="p">];</span>

<span class="p">}</span>
</code></pre></div>
<h1>应对滚动事件</h1>

<p>我们目前实现的代码将会提供一个正常滑动只有静态感觉的UICollectionView；运行起来没什么特别的。看上去很好，但是不是真的动态，不是么？</p>

<p>为了实现动态行为，我们需要我们布局和dynamic animator 能够对collection view 中的滑动位置的变化做出反应。幸好这里有个非常适合这个要求的方法shouldInvalidateLayoutForBoundsChange:。这个方法会在collection view 的边界发生改变的时候被调用，并且他提供了一个调整dynamic animator中的行为物品到一个新的content offset的时机。因为dynamic animator 会关心使我们的布局无效，但是在这种情况下，它不需要这么做:</p>
<div class="highlight"><pre><code class="objc language-objc" data-lang="objc"><span class="k">-</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">shouldInvalidateLayoutForBoundsChange:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">newBounds</span> 
<span class="p">{</span>
    <span class="n">UIScrollView</span> <span class="o">*</span><span class="n">scrollView</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">newBounds</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

    <span class="n">CGPoint</span> <span class="n">touchLocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">.</span><span class="n">panGestureRecognizer</span> <span class="n">locationInView</span><span class="o">:</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">];</span>

    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span><span class="p">.</span><span class="n">behaviors</span> <span class="n">enumerateObjectsUsingBlock</span><span class="o">:^</span><span class="p">(</span><span class="n">UIAttachmentBehavior</span> <span class="o">*</span><span class="n">springBehaviour</span><span class="p">,</span> <span class="n">NSUInteger</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CGFloat</span> <span class="n">yDistanceFromTouch</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">touchLocation</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">springBehaviour</span><span class="p">.</span><span class="n">anchorPoint</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">CGFloat</span> <span class="n">xDistanceFromTouch</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">touchLocation</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">springBehaviour</span><span class="p">.</span><span class="n">anchorPoint</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
        <span class="n">CGFloat</span> <span class="n">scrollResistance</span> <span class="o">=</span> <span class="p">(</span><span class="n">yDistanceFromTouch</span> <span class="o">+</span> <span class="n">xDistanceFromTouch</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1500.0f</span><span class="p">;</span>

        <span class="n">UICollectionViewLayoutAttributes</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">springBehaviour</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">firstObject</span><span class="p">;</span>
        <span class="n">CGPoint</span> <span class="n">center</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">center</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">center</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="o">*</span><span class="n">scrollResistance</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
            <span class="n">center</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="o">*</span><span class="n">scrollResistance</span><span class="p">);</span>

    <span class="p">}</span>
        <span class="n">item</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">;</span>

        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dynamicAnimator</span> <span class="n">updateItemUsingCurrentState</span><span class="o">:</span><span class="n">item</span><span class="p">];</span>

    <span class="p">}];</span>

    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>
<p>让我们仔细查看这个实现的细节。首先我们得到了这个scroll view(这是我们的collection view)，然后计算它的content offset中y的变化(在这个例子中，我们的collection view是垂直滑动的)。一旦我们得到这个增量，我们需要得到用户接触的位置。这是非常重要的，因为我们希望离接触位置比较近的那些物品能移动地更即时，而离接触位置比较远的那些物品则应该落后。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ReactiveCocoa学习笔记</title>
      <link href="http://morisunshine.com/2014/02/24/study_with_RAC/"/>
      <pubDate>2014-02-24T00:00:00+08:00</pubDate>
      <author>morisunshine</author>
      <guid>http://morisunshine.com/2014/02/24/study_with_RAC</guid>
      <content:encoded><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#introduce_FRP"><strong>什么是FRP</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#introduce_RAC"><strong>介绍RAC</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#Framework"><strong>基本框架</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#important_idea"><strong>重要概念</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#basic_operator"><strong>基本操作</strong></a>  </p>

<p>ReactiveCocoa（其简称为RAC）是实现<a href="http://en.wikipedia.org/wiki/Functional_reactive_programming">Functional Reactive Programming</a>的iOS新框架，在<a href="http://www.raywenderlich.com/">Raywenderlich</a>的一个<a href="http://www.raywenderlich.com/55384/ios-7-best-practices-part-1">天气应用的教程</a>里，我第一次接触到了它，教程中虽然没有过多介绍，但只说了一点，我觉得非常有概括性 --- <strong>your code can react to nondeterministic events</strong>(你的代码能对不确定性事件做出反应)。</p>

<p><a id='introduce' name='introduce_FRP'> </a></p>

<h2>什么是FRP?</h2>

<hr>
]]></content:encoded>
    </item>
    
    <item>
      <title>制作自己的Gem</title>
      <link href="http://morisunshine.com/2014/02/19/make_your_own_gem/"/>
      <pubDate>2014-02-19T00:00:00+08:00</pubDate>
      <author>morisunshine</author>
      <guid>http://morisunshine.com/2014/02/19/make_your_own_gem</guid>
      <content:encoded><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#introduce"><strong>什么是Gem？</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#first_gem"><strong>第一个Gem</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#include_more_files"><strong>包含更多文件</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#adding_an_executable"><strong>添加可执行文件</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#writing_tests"><strong>测试</strong></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#documenting_your_code"><strong>文档</strong></a>  </p>

<p><a id='introduce' name='introduce'> </a></p>

<h2>什么是Gem?</h2>

<p>RubyGems是一个方便而强大的Ruby程序包管理器，Ruby的第三方插件是用gem方式来管理，非常容易发布和共享，一个简单的命令就可以安装上第三方的扩展库。特点：能远程安装包，包之间依赖关系的管理，简单可靠的卸载，查询机制，能查询本地和远程服务器的包信息，能保持一个包的不同版本，基于Web的查看接口，能查看你安装的gem的信息。</p>

<hr>

<p><a id='first_gem' name='first_gem'> </a></p>

<h2>第一个Gem</h2>

<p>我们要创建一个名叫<code>moondemo</code>的gem，首先，就要创建一个名字为<code>moondemo_yourname</code>的目录，这个是为了后面的发布，如果你想发布的话，就要检查一下你的gem名字是否已经被人使用了，如果已经被人使用，那就要换个名字了。<br>
然后这个目录里的基本文件结构应该是这样的。 </p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">tree</span>  
<span class="o">.</span>  
<span class="err">├──</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>    
<span class="err">├──</span> <span class="n">lib</span>  
<span class="err">│  </span> <span class="err">└──</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">rb</span>  
</code></pre></div>
<p>gem中的代码被放在<code>lib</code>目录中，这里有个约定就是<code>lib</code>中必须有个和gem同名的ruby文件，这样当<code>require &#39;moondemo&#39;</code>运行的时候，这个gem就会被加载，这个文件就是负责配置你的gem的代码和API。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">cat</span> <span class="n">lib</span><span class="o">/</span><span class="n">moondemo</span><span class="o">.</span><span class="n">rb</span>
<span class="k">class</span> <span class="n">moondemo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hi</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello world!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>而<code>.gemspec</code>文件是定义了这个gem的信息，比如是这个gem的功能，作者等，并且当这个gem发布的时候，会将这些信息显示到这个gem的主页上(就像<a href="http://rubygems.org/gems/jekyll">jekyll</a>)。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span>  <span class="n">cat</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s1">&#39;moondemo&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">date</span>        <span class="o">=</span> <span class="s1">&#39;2014-02-19&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="s2">&quot;moondemo!&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;A simple hello world gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;sheldon huang&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="s1">&#39;allenwenzhou@gmail.com&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">files</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib/moondemo.rb&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span>
    <span class="s1">&#39;http://rubygems.org/gems/moondemo&#39;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">license</span>       <span class="o">=</span> <span class="s1">&#39;MIT&#39;</span>
<span class="k">end</span>
</code></pre></div>
<p>这里有很多选项，一看名字就知道他们是要代表什么内容的，如果你还想知道更多就看一些这个<a href="http://guides.rubygems.org/specification-reference/">文档</a></p>

<p>当我们创建完成了一个.gemspec，就可以编译出一个gem了，是不是有点小激动啊。但如果想要测试它就必须要在本地安装编译好的gem。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">build</span> <span class="n">moondemo</span><span class="o">.</span><span class="n">gemspec</span>
  <span class="no">Successfully</span> <span class="n">built</span> <span class="no">RubyGem</span>
  <span class="ss">Name</span><span class="p">:</span> <span class="n">moondemo</span>
  <span class="ss">Version</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="ss">File</span><span class="p">:</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>

<span class="err">➜</span> <span class="n">gem</span> <span class="n">install</span> <span class="o">.</span><span class="n">/moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>
<span class="no">Successfully</span> <span class="n">installed</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Parsing</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Installing</span> <span class="n">ri</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="mi">1</span> <span class="n">gem</span> <span class="n">installed</span>
</code></pre></div>
<p>上面这些步骤，只能是在本地已经装好了我们自己的gem，但还没有使用它，
我们需要<code>require</code>这个gem然后根据自己定义的方法来使用它。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">irb</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span>
<span class="no">Hello</span> <span class="n">world!</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div>
<p>现在就可以将你的gem发布到Ruby社区上了，当在发布之前需要将你的帐号安装在电脑上，如果你在RubyGems.org上注册了帐号，那就只需要输入一个命令,再输入自己的密码就可以了</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="err">你的帐号名</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">rubygems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">api_key</span><span class="o">.</span><span class="n">yaml</span> <span class="o">&gt;</span> <span class="o">~</span><span class="sr">/.gem/</span><span class="n">credentials</span><span class="p">;</span> <span class="n">chmod</span> <span class="mo">0600</span> <span class="o">~</span><span class="sr">/.gem/</span><span class="n">credentials</span>

<span class="no">Enter</span> <span class="n">host</span> <span class="n">password</span> <span class="k">for</span> <span class="n">user</span> <span class="s1">&#39;你的帐号名&#39;</span><span class="p">:</span>
</code></pre></div>
<p>一旦你的用户名已经被安装了，就可以直接发布你的gem了。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">push</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="n">gem</span>
<span class="no">Pushing</span> <span class="n">gem</span> <span class="n">to</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">rubygems</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="no">Successfully</span> <span class="n">registered</span> <span class="ss">gem</span><span class="p">:</span> <span class="n">moondemo</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>很快的，你的gem就可以被任何人使用了</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">moondemo</span>
<span class="no">Successfully</span> <span class="n">installed</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="no">Parsing</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">moondemo</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="mi">1</span> <span class="n">gem</span> <span class="n">installed</span>
</code></pre></div>
<p>用Ruby和RubyGems来分享代码是不是很简单。</p>

<hr>

<p><a id='include_more_files' name='include_more_files'> </a></p>

<h2>包含更多文件</h2>

<p>我们以后代码当然不会这么简单，如果代码变得非常多了之后，该怎么办呢，当然是要是要将代码分到不同的文件中了。<br>
比如我们想在刚才的gem中添加根据不同语言来输出不同语言的&quot;Hello world&quot;。<br>
我们就可以添加一个<code>Translator</code>文件，刚才提到过，gem的根文件是负责加载代码的，所以其他的功能的文件就需要放在<code>lib</code>中和gem同名的目录中，我们可以这样分:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">➜ tree
.
├── lib
│   ├── moondemo
│   │   └── translator.rb
│   └── moondemo.rb
├── moondemo-0.0.1.gem
</code></pre></div>
<p><code>Translator</code>中的内容是:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Translator</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="vi">@language</span> <span class="o">=</span> <span class="n">language</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hi</span>
    <span class="k">case</span> <span class="vi">@language</span>
      <span class="k">when</span> <span class="s2">&quot;chinese&quot;</span>
        <span class="s2">&quot;你好，世界!&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;Hello world!&quot;</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>所以接下来，<code>moondemo.rb</code>中需要加载<code>Translator</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MoonDemo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hi</span><span class="p">(</span><span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="no">Translator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="n">translator</span><span class="o">.</span><span class="n">hi</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>注意:每次新建了一个目录或者文件，都不要忘记加到.gemspec文件中，就像这样</em></p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"> <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Sheldon&quot;</span><span class="o">]</span>
 <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="s1">&#39;allenwenzhou@gmial.com&#39;</span>
 <span class="n">s</span><span class="o">.</span><span class="n">files</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib/moondemo.rb&quot;</span><span class="p">,</span><span class="s2">&quot;lib/moondemo/translator.rb&quot;</span><span class="o">]</span>
</code></pre></div>
<p><em>如果没有上面的修改的话，这个新建的目录是不会被加载到已安装的gem里的</em></p>

<p>让我们再运行一篇</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="err">➜</span> <span class="n">irb</span> <span class="o">-</span><span class="no">Ilib</span> <span class="o">-</span><span class="n">rmoondemo</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;Hello world!&quot;</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;你好，世界!&quot;</span>
</code></pre></div>
<p>这里我们使用了一个新的命令行<code>-Ilib</code>,通常RubyGems会为你包含了<code>lib</code>路径，所以很多时候，我们不需要去考虑配置它们的加载路径，但是，如果你把代码运行在RubyGems的项目之外，你就要自己去配置这些了。</p>

<p>如果你添加了一些新的文件到你的gem中，那么你一定要记住在发布之前将这些文件添加到你的<code>.gemspec</code>的<code>files</code>数组中。这样很麻烦是么，所以很多人就选择用<a href="http://docs.seattlerb.org/hoe/">Hoe</a>,<a href="https://github.com/technicalpickles/jeweler">Jeweler</a>,<a href="http://rake.rubyforge.org/classes/Rake/GemPackageTask.html">Rake</a>,<a href="http://railscasts.com/episodes/245-new-gem-with-bundler">Bundler</a>或者用<a href="https://github.com/wycats/newgem-template/blob/master/newgem.gemspec">动态的gemspec</a>来实现自动化。</p>

<p>添加更多的目录也都是按照上面一样的步骤，我们要将我们的文件结构分布合理，这样对于我们以后的维护和未来开发人员来说就不会是一件头疼的事儿了。</p>

<p><a id='adding_an_executable' name='adding_an_executable'> </a></p>

<h2>添加可执行文件</h2>

<p>gem除了可以提供Ruby代码库外，还可以在你的可执行文件路径里提供很多可执行可执行文件文件。可能最有名的就是<code>rake</code>，
添加一个可执行可执行可执行文件文件其实很简单，你只需要将你的可执行文件放在你的gem的<code>bin</code>目录下，然后在将这个文件添加到<code>.gemspec</code>文件中<code>executables</code>的列表里就可以了，让我们试一下:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">➜  mkdir bin
➜  touch bin/moondemo
➜  chmod a+x bin/moondemo
</code></pre></div>
<p>这个可执行文件只需要在开头用<a href="http://www.catb.org/jargon/html/S/shebang.html">shebang</a>来表明这是用程序来运行的，下面就是这个可执行文件的内容:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>
<span class="nb">puts</span> <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</code></pre></div>
<p>这个可执行文件的内容很简单，它只是加载了moondemo这个gem，然后在命令行中通过输入一个参数来判断是用哪个国家的语言来说&quot;hello, world&quot;。下面就是运行的例子:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">➜  ruby -Ilib ./bin/moondemo
Hello world!
➜  ruby -Ilib ./bin/moondemo chinese
你好，世界!
</code></pre></div>
<p>最后，我们要将这个可执行文件添加到<code>.gemspec</code></p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">s</span><span class="o">.</span><span class="n">executables</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;moondemo&#39;</span>
</code></pre></div>
<p>更新你的gem，上传到官网上，这样你就可以在命令行中有自己的命令了，是不是很帅啊。这里要提醒一下，上传新的gem时，要记得修改<code>.gemspec</code>中的版本号。详情看<a href="http://guides.rubygems.org/patterns/#semantic-versioning">这儿</a></p>

<p>在看一下用我们自己定义的命令行吧:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">➜  ~  moondemo
Hello world!
➜  ~  moondemo chinese
你好，世界!
</code></pre></div>
<p>世界在向我们招手呢。哈哈哈~~~</p>

<p><a id='writing_tests' name='writing_tests'> </a></p>

<h1>测试</h1>

<p>测试我们的gem是非常重要的，它不仅保证了这个gem是正常的，也保证了别人能知道你的gem是正常的。当我们评价一个gem的时候，很多Ruby开发者会倾向于通过查看测试用例来做为主要依据。</p>

<p>Gems是支持将测试文件添加到程序包中的，所以当gem被下载了之后，我们可以直接运行测试用例。这里有个帮助我们如何在不同框架和解释器下写测试用例的社区叫<a href="http://test.rubygems.org/">GemTesters</a>
总而言之:去测试我们的Gem吧！啥都别想了！</p>

<p><code>Test::Unit</code>是Ruby的自带测试框架。这里有很多<a href="https://github.com/seattlerb/minitest/blob/master/README.txt">教程</a>，当然还是有很多其他的测试框架，<a href="http://rspec.info/">RSpec</a>就是比较有名的一个，是不是迫不及待，让我们测试吧！</p>

<p>我们需要在原来的基础上再添加一些文件，一个名为<code>Rakefile</code>的文件和一个名为<code>test</code>的目录:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">.
├── Rakefile
├── bin
│   └── moondemo
├── lib
│   ├── moondemo
│   │   └── translator.rb
│   └── moondemo.rb
├── moondemo-0.0.1.gem
├── moondemo.gemspec
├── npm-debug.log
└── <span class="nb">test</span>
    └── test_moondemo.rb
</code></pre></div>
<p><code>Rakefile</code>文件是为了实现自动化的测试:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rake/testtask&#39;</span>

<span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="o">.</span><span class="n">libs</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;test&#39;</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s2">&quot;Run tests&quot;</span>
<span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="ss">:test</span>
<span class="o">~</span>
</code></pre></div>
<p>下面就是一个简单的测试用例了:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;moondemo&#39;</span>

<span class="k">class</span> <span class="nc">MoonDemoTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="k">def</span> <span class="nf">test_english_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;Hello world!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_any_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;Hello world!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;ruby&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_spanish_hello</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;你好，世界!&quot;</span><span class="p">,</span>
      <span class="no">MoonDemo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>最后，让我们运行这个测试:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">➜  rake <span class="nb">test</span>
Run options:

<span class="c"># Running tests:</span>

Finished tests in 0.006151s, 487.7256 tests/s, 487.7256 assertions/s.
3 tests, 3 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div>
<p>很好，全部都通过了！</p>

<p><a id='documenting_your_code' name='documenting_your_code'> </a></p>

<h1>文档</h1>

<p>文档和测试是一样重要的，大部分gem都是用RDoc来生成文档的，这里有很多<a href="http://docs.seattlerb.org/rdoc/RDoc/Markup.html">教程</a>.
很简单，先切换到gem的根目录下，再命令行中输入<code>rdoc</code>，你就会发现多出了一个名为<code>doc</code>的目录，里面就是我们的文档了，当然你可以自己再进行一些调整。
除了RDoc呢，我们还有另外的选择<a href="http://yardoc.org/">YARD</a>，当我们发布了gem的时候呢，<a href="http://rubydoc.info/">RubyDoc.info</a>会根据你的gem自动生成YARDocs，并且它是可以向下兼容RDoc。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>第一篇博客</title>
      <link href="http://morisunshine.com/2014/02/15/myfirstblog/"/>
      <pubDate>2014-02-15T00:00:00+08:00</pubDate>
      <author>morisunshine</author>
      <guid>http://morisunshine.com/2014/02/15/myfirstblog</guid>
      <content:encoded><![CDATA[<p>果然生命在于折腾啊，折腾完之后，就会发现之前觉得挺难的事其实也没什么大不了嘛，比如这个弄博客，以前对牛人的概念就是有个自己域名的博客，感觉好牛的样子，当自己有勇气想自己也去搞一个时，发现原来这么简单，只要买个域名，然后就可以了，当然那些有些博客是很牛的，但对我来说，这样简单的博客就是我想要的，而内容才是博客最重要的地方。至于我会在博客里写什么，我想到什么就写什么，我觉得记录是很重要的能力，我想将我的一些学习经验，对自己工作的认识，人生领悟，生活点滴都记录在这里，希望这里就是我的世界。</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>站在原地, 心存远方</title>
      <link href="http://morisunshine.com/2013/01/10/travel-to-qinghai/"/>
      <pubDate>2013-01-10T00:00:00+08:00</pubDate>
      <author>morisunshine</author>
      <guid>http://morisunshine.com/2013/01/10/travel-to-qinghai</guid>
      <content:encoded><![CDATA[<p><img src="/assets/images/p7796217.jpg" alt="图片"></p>

<p><img src="/assets/images/p7796228.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
印象中，独自旅行是最浪漫的方式，就像一个侠客，可以在天地之间任我飘逸。在兰州与同学们分开之后，我并开始了自己盼望已久的独自旅行，身边虽然没有可以了熟悉的朋友，却可以在路上遇到许多朋友，孤独也有孤独的自由。在通过同学的推荐下,我知道甘南这个地方,后来又在青旅里做过一些攻略，但是看来看去，最后还是只记住几个地名就上路了，太详细的攻略固定了旅行的不确定性，虽然保证了安全，却失去了很多乐趣。在来甘南之前，我在兰州的青旅里认识了在云南开酒吧的纪姐,还有一个在四川上大学的妹子,后来又在去夏河的大巴上认识了一个退伍军人，我们都叫他鞋子，还有两个女孩，我们就一起结伴。在夏河的最深印象就是出租车，无论到哪里都是一块钱，就像坐公交车一样方便。我们三天一直住在宝马宾馆，住宿费很便宜，只要15块钱一个晚上，白天我们一起去看了拉卜楞寺，桑科草原，八角古城，到了晚上就逛夏河，淘一些饰品带回去。我们到八角城的时候，就碰到一位夏河文化馆的馆长，原来他老家就在八角城，他那天是回家探亲，他很热情地为我们介绍这座有三千多年历史的八角古城，由于风化，原来的古城墙早已面目全非，只有站在高处，才能看到八角城的轮廓。馆长又把我们带到了一个小庙，那个小庙只有教室大小，然而里面却是整洁干净，在墙的周围种着娇艳的花朵，而地板上就像所有藏族区的寺庙一样被那些虔诚的藏民们跪得光滑，这时纪姐叫我们给这寺庙捐些钱，我就从兜里掏出五块钱想给守庙人，可是守庙人看到之后，拼命摇头，用藏语和馆长说了几句话，馆长对我们说“他说你们是远方来的客人，旅费本来就不多，你们还是自己用吧。”我当时听了之后，不知道该用什么语言去表达，相信这就是信仰下的善良，他们虽然物质匮乏内心却无比充实，而在那些物质丰富的大城市里，大部分人却活的并不快乐。后来我们又在街上闲逛，几个老人看见我们都很大方地向我们招手，我们对他们说“扎西得嘞”，他们也微笑地回应我们，在八角城的街头，总是能看到一个老人，手上拿着转经筒，端坐在地上，看着远处，我们静静走过，不忍心打扰。当我们准备离开的时候，一群孩子跑到村头向我们挥手，那一个个纯真的脸里上都是那个年龄该有的快乐。在回去的路上，我一直在想，是不是物质的匮乏反而让灵魂有地方栖息。
</p>

<p><img src="/assets/images/p7796213.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
在夏河的第四天，我们的路线开始不同，我要回兰州坐火车回家了，他们还要继续旅行，于是和他们挥手再见。和他们分手之后，我还有一天的时间，打算去最近的合作市去看看，那天不是很急，就先去拉卜楞寺又转了一圈转经长廊，在转经筒的时候，心里不知道该默念什么，当时有了搭车去合作的想法，于是心里就开始默念成功搭到车，可是后来又想还是保佑自己快乐吧，后来又想是不是该保佑爸妈快乐，身体健康呢，又想还有朋友呢，于是贪心越来越大，就想佛祖不会保佑这么贪心的人的，还是保佑自己快乐吧，我快乐，关心我的人也会快乐，别人快乐所以我也会快乐，有因必有果。
</p>

<p><img src="/assets/images/p7796219.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
搭车是我很意外的想法，本来这次旅行并没有搭车的准备，但是在青旅里遇到很多人都有过搭车的经历，听他们说起来自己的搭车经历觉得很简单，又很好玩，就想尝试一下，但是后来我跟同学说了这个想法之后，她说搭车不是那么容易的，会被拒绝很多次的。当时心里在犹豫，可是后来一想，拒绝就拒绝吧，又不会把我怎么样，旅行就是要尝试一下才有意思。就这样在旅行的最后一站，我举起了大拇指。我一边走一边问路人去合作的方向，一看到有车子经过就举起大拇指，可是大部分都是出租车停了下来，有些司机并没有理我，有些司机还是很和善地向我摇了摇手，我就一直向前方走，终于在一个路口，停下了一辆小面包车，坐在副驾驶座的大叔摇下窗户问我“你要去哪里？”我说：“我要去合作。”然后那个大叔就和驾驶座上的司机说了一下，就对我说“上来吧”。我很兴奋地坐上了后座，终于搭到第一辆车啦，可是没开多少里路，那个大叔转过头来对我说，一会儿给司机15块钱，我听了之后就懵了，后来就想给了钱就不叫搭车了，于是就叫司机在前面把我放下。又问了了路边的一个大叔这是不是去合作的方向，大叔点点头，我就又举起大拇指，刚举起大拇指，就又有一辆面包车停下来，打开车门叫我上来，由于刚才的经历，我对司机说的第一句话却是“要钱么？”司机大叔摇了摇头，我就上车了，心中羞愧自己的冒失，司机大叔好像在用藏语和家人聊天，我一句都听不懂，我想说谢谢，却不好意思打扰，当他一放下电话的时候，他就开口问我，“你是哪里人？”我说“我是浙江的”，于是就这样没有准备却很自然的聊了起来，慢慢地我的紧张感也慢慢放松下来，跟他说了自己最近的经历啊，司机大叔又跟我说了自己最近担忧的事，比如对这一代藏族孩子对信仰越来越不重视，还有到处修建的公路破坏了环境，他说开车有三十多年了，回忆起以前开车的日子，以前开车的时候虽然路况不好，窗外的风景却很美，即使开车的时候很颠簸，却依然很快乐。他后来又给我说了很多藏传佛教的知识，推荐了一些甘南比较美的地方，还教了我几句藏语，最后把我送到了合作的一个景点，九层佛阁，还告诉我在哪里可以坐到回兰州的大巴，我用他教我的藏语和他说“再见”。他和开心地和我挥手再见，开玩笑地说“回兰州可不能搭车咯”，我微笑地点点头。
</p>

<p><img src="/assets/images/p7796225.jpg" alt="图片"></p>

<p style="text-indent: 2em;">
旅行的意义是什么，在这次旅行之前，我好像很清楚，因为很多书中都可以找到，逃离原来的安全圈，发现自我，做自己想做的事情等等。可是，旅行之后，我却说不清楚，也许只是一次行走，从一个地方走到另一个地方，看看风景，与路上的人交朋友，互相交换故事，仅此而已。此刻我终于明白了《迟到的间隔年》中的一段话“旅行是寻找不到答案的，它只会让你多了选择，甚至更加迷茫，但完全值得”，当你在旅行中过于强调意义，注定得不到什么。所以冷暖自知，总有言语无泅行中过于强调意义，注定得不到什么。所以冷暖自知，总有言语无泅行中过于强调意义，注定得不到什么。所以冷暖自知。
</p>

<p><img src="/assets/images/p7796220.jpg" alt="图片"></p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
